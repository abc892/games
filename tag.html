<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arena Tag Showdown - Multiplayer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      overflow: hidden;
      font-family: 'Rajdhani', sans-serif;
      background: #0a0e27;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #fff;
    }
    
    .game-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    canvas {
      display: block;
      border: 4px solid #00ffff;
      box-shadow: 0 0 40px rgba(0, 255, 255, 0.6), inset 0 0 20px rgba(0, 255, 255, 0.2);
      border-radius: 12px;
      background: linear-gradient(135deg, #1a1a3e 0%, #0f0f23 100%);
    }
    
    /* Screens */
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(10, 14, 39, 0.98);
      z-index: 200;
      overflow-y: auto;
    }
    
    .screen.active {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .menu-container {
      background: linear-gradient(135deg, rgba(20, 30, 60, 0.95), rgba(10, 15, 35, 0.95));
      border: 3px solid #00ffff;
      border-radius: 24px;
      padding: 50px 40px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 0 60px rgba(0, 255, 255, 0.4), inset 0 0 30px rgba(0, 255, 255, 0.05);
      margin: 20px;
    }
    
    .menu-title {
      font-family: 'Orbitron', sans-serif;
      color: #00ffff;
      font-size: 56px;
      font-weight: 900;
      text-align: center;
      margin-bottom: 15px;
      text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff;
      animation: titlePulse 3s infinite;
      letter-spacing: 4px;
    }
    
    @keyframes titlePulse {
      0%, 100% { text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff; }
      50% { text-shadow: 0 0 40px #00ffff, 0 0 80px #00ffff, 0 0 100px #00ffff; }
    }
    
    .subtitle {
      text-align: center;
      color: #00d4ff;
      font-size: 20px;
      margin-bottom: 30px;
      font-weight: 300;
      letter-spacing: 2px;
    }
    
    .menu-btn {
      width: 100%;
      padding: 20px;
      margin: 15px 0;
      background: linear-gradient(135deg, #00ffff, #00b8d4);
      border: none;
      border-radius: 12px;
      color: #0a0e27;
      font-size: 22px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      letter-spacing: 2px;
      position: relative;
      overflow: hidden;
    }
    
    .menu-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .menu-btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .menu-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 40px rgba(0, 255, 255, 0.5);
    }
    
    .menu-btn.danger {
      background: linear-gradient(135deg, #ff4757, #ee5a6f);
    }
    
    .menu-btn.secondary {
      background: linear-gradient(135deg, #a29bfe, #6c5ce7);
    }
    
    .menu-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 20px;
      margin: 15px 0;
      background: rgba(0, 255, 255, 0.05);
      border: 2px solid #00ffff;
      border-radius: 12px;
      color: #00ffff;
      font-size: 20px;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: #00ffff;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      background: rgba(0, 255, 255, 0.1);
    }
    
    input::placeholder {
      color: rgba(0, 255, 255, 0.5);
    }
    
    /* HUD */
    #hud {
      position: absolute;
      top: 30px;
      left: 30px;
      color: #00ffff;
      font-size: 28px;
      text-shadow: 0 0 20px #00ffff;
      z-index: 100;
      pointer-events: none;
      font-weight: 700;
      font-family: 'Orbitron', sans-serif;
    }
    
    #timer {
      position: absolute;
      top: 30px;
      right: 30px;
      color: #ffd700;
      font-size: 36px;
      text-shadow: 0 0 30px #ffd700;
      z-index: 100;
      pointer-events: none;
      font-weight: 900;
      font-family: 'Orbitron', sans-serif;
    }
    
    /* Lobby */
    .lobby-code {
      text-align: center;
      font-size: 48px;
      color: #ffd700;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
      padding: 25px;
      border-radius: 16px;
      margin: 25px 0;
      border: 3px solid #ffd700;
      letter-spacing: 12px;
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
    }
    
    .player-list {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 25px;
    }
    
    .player-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      margin: 12px 0;
      background: rgba(0, 255, 255, 0.05);
      border: 2px solid #00ffff;
      border-radius: 12px;
      color: #00ffff;
      font-size: 20px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .player-entry:hover {
      background: rgba(0, 255, 255, 0.1);
      transform: translateX(5px);
    }
    
    .player-entry.ready {
      background: rgba(0, 255, 100, 0.15);
      border-color: #00ff88;
      color: #00ff88;
    }
    
    .player-entry.current-user {
      background: rgba(255, 215, 0, 0.15);
      border-color: #ffd700;
      color: #ffd700;
    }
    
    .player-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff4757;
      animation: statusPulse 2s infinite;
    }
    
    .player-entry.ready .status-indicator {
      background: #00ff88;
    }
    
    @keyframes statusPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Pause Button */
    #pauseBtn {
      position: absolute;
      top: 100px;
      right: 30px;
      padding: 15px 35px;
      background: rgba(0, 255, 255, 0.2);
      border: 3px solid #00ffff;
      border-radius: 12px;
      color: #00ffff;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      z-index: 100;
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s;
      letter-spacing: 2px;
    }
    
    #pauseBtn:hover {
      background: rgba(0, 255, 255, 0.4);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
      transform: scale(1.05);
    }
    
    /* Game Over */
    #gameOver {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 42px;
      color: #fff;
      background: linear-gradient(135deg, rgba(10, 14, 39, 0.95), rgba(20, 30, 60, 0.95));
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      display: none;
      z-index: 20;
      box-shadow: 0 0 60px rgba(0, 255, 255, 0.4);
      border: 3px solid #00ffff;
      font-family: 'Orbitron', sans-serif;
    }
    
    #winner-text {
      color: #ffd700;
      font-weight: 900;
      margin: 25px 0;
      font-size: 32px;
      text-shadow: 0 0 30px #ffd700;
    }
    
    .retry-btn {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      font-size: 22px;
      padding: 18px 40px;
      margin-top: 20px;
      border: none;
      border-radius: 12px;
      color: #0a0e27;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .retry-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 40px rgba(255, 152, 0, 0.5);
    }
    
    /* Pause Menu */
    #pause-menu {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(20, 30, 60, 0.98));
      padding: 50px;
      border-radius: 20px;
      text-align: center;
      z-index: 40;
      color: white;
      width: 400px;
      display: none;
      box-shadow: 0 0 60px rgba(0, 255, 255, 0.4);
      border: 3px solid #00ffff;
    }
    
    /* Countdown */
    #countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 150px;
      color: #00ffff;
      z-index: 25;
      display: none;
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      text-shadow: 0 0 50px #00ffff, 0 0 100px #00ffff;
      animation: countdownPulse 1s infinite;
    }
    
    @keyframes countdownPulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
    }
    
    /* Waiting Room */
    .waiting-message {
      text-align: center;
      color: #00d4ff;
      font-size: 24px;
      margin: 30px 0;
      padding: 20px;
      background: rgba(0, 212, 255, 0.1);
      border-radius: 12px;
      border: 2px solid #00d4ff;
      animation: waitingPulse 2s infinite;
    }
    
    @keyframes waitingPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #00ffff;
      border-radius: 6px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #00d4ff;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div id="ui" style="display: none;">Time: 0</div>
    <button id="pauseBtn" style="display: none;">‚è∏ PAUSE</button>
    
    <!-- Game Over Display -->
    <div id="gameOver">
      <h2 style="font-size: 48px; margin-bottom: 20px;">üèÅ GAME OVER!</h2>
      <div id="winner-text"></div>
      <div style="margin: 25px 0; font-size: 20px; color: #00d4ff;">
        <p>Press SPACEBAR or click button to continue</p>
        <button class="retry-btn" onclick="continueAfterGame()">CONTINUE</button>
      </div>
    </div>
    
    <!-- Countdown -->
    <div id="countdown"></div>
    
    <!-- Pause Menu -->
    <div id="pause-menu">
      <h2 style="font-family: 'Orbitron', sans-serif; font-size: 36px; margin-bottom: 30px;">‚è∏ PAUSED</h2>
      <button class="menu-btn" onclick="resumeGame()">Resume Game</button>
      <button class="menu-btn danger" onclick="leaveGame()">Leave Game</button>
    </div>
    
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen active">
      <div class="menu-container">
        <div class="menu-title">üèÉ ARENA TAG</div>
        <div class="subtitle">MULTIPLAYER SHOWDOWN</div>
        <input type="text" id="nameInput" placeholder="Enter your name" maxlength="20">
        <button class="menu-btn" onclick="saveUserName()">START</button>
      </div>
    </div>
    
    <!-- Home Screen -->
    <div id="homeScreen" class="screen">
      <div class="menu-container">
        <div class="menu-title">üèÉ ARENA TAG</div>
        <div class="subtitle">Welcome back, <span id="welcomeName"></span>!</div>
        <button class="menu-btn" onclick="createLobby()">CREATE LOBBY</button>
        <input type="text" id="joinCodeInput" placeholder="Enter 6-digit code" maxlength="6">
        <button class="menu-btn secondary" onclick="joinLobby()">JOIN LOBBY</button>
      </div>
    </div>
    
    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="screen">
      <div class="menu-container">
        <div class="menu-title">üéÆ LOBBY</div>
        <div class="lobby-code" id="lobbyCode">------</div>
        <div class="subtitle">Share this code with friends!</div>
        
        <div id="waitingMessage" class="waiting-message" style="display: none;">
          ‚è≥ Waiting for players to ready up...
        </div>
        
        <div class="player-list" id="playerList"></div>
        
        <div style="margin-top: 30px;">
          <label style="color: #00ffff; font-size: 18px; margin-bottom: 10px; display: block;">
            ‚è± Game Duration (seconds):
          </label>
          <input type="number" id="gameDuration" min="30" max="300" value="60" 
                 style="text-align: center; font-size: 24px; font-weight: 700;">
        </div>
        
        <button class="menu-btn" id="readyBtn" onclick="toggleReady()">READY</button>
        <button class="menu-btn danger" onclick="leaveLobby()">LEAVE LOBBY</button>
      </div>
    </div>
    
    <canvas id="gameCanvas" width="1200" height="700"></canvas>
    
    <!-- HUD -->
    <div id="hud" style="display: none;">
      TIME: <span id="timer">0</span>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, update, remove, onValue, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyAwEy-sJx7E61BA6VmBfIFMZsjuAj8RK5g",
      authDomain: "games-c3e27.firebaseapp.com",
      databaseURL: "https://games-c3e27-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "games-c3e27",
      storageBucket: "games-c3e27.firebasestorage.app",
      messagingSenderId: "193027632069",
      appId: "1:193027632069:web:b559c3b10011bc6982b9ac"
    };
    
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // Game Constants
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gravity = 0.5;
    
    // Player Colors
    const PLAYER_COLORS = [
      '#00ffff', '#ff4757', '#ffd700', '#00ff88', 
      '#ff6b9d', '#c44569', '#4bcffa', '#ffa502',
      '#5f27cd', '#00d2d3'
    ];
    
    // Game State
    let gameState = {
      userId: null,
      userName: null,
      currentLobby: null,
      isPlaying: false,
      isPaused: false,
      isHost: false,
      playerColor: null,
      localPlayer: null,
      startTime: 0,
      timer: 60,
      frameCount: 0
    };
    
    let otherPlayers = {};
    let lobbyListener = null;
    let gameInterval = null;
    let currentPlatforms = [];
    const keys = {};
    const keyState = {};
    
    // Platform definitions
    const basePlatforms = [
      { x: 100, y: 550, w: 80, h: 15 },
      { x: 250, y: 500, w: 70, h: 15 },
      { x: 400, y: 450, w: 80, h: 15 },
      { x: 550, y: 500, w: 70, h: 15 },
      { x: 700, y: 550, w: 80, h: 15 },
      { x: 850, y: 500, w: 70, h: 15 },
      { x: 1000, y: 450, w: 80, h: 15 },
      { x: 200, y: 350, w: 70, h: 15 },
      { x: 400, y: 300, w: 80, h: 15 },
      { x: 600, y: 350, w: 70, h: 15 },
      { x: 800, y: 300, w: 80, h: 15 },
      { x: 1000, y: 350, w: 70, h: 15 },
      { x: 300, y: 200, w: 80, h: 15 },
      { x: 500, y: 150, w: 70, h: 15 },
      { x: 700, y: 200, w: 80, h: 15 },
      { x: 900, y: 150, w: 70, h: 15 },
      { x: 200, y: 620, w: 90, h: 15 },
      { x: 900, y: 620, w: 90, h: 15 }
    ];
    
    // Event Listeners
    document.addEventListener('keydown', e => {
      keys[e.key] = true;
      if (!keyState[e.key]) {
        keyState[e.key] = { pressed: true, justPressed: true };
      } else {
        keyState[e.key].justPressed = true;
      }
      
      if (e.key === ' ' && document.getElementById('gameOver').style.display === 'block') {
        continueAfterGame();
      }
    });
    
    document.addEventListener('keyup', e => {
      keys[e.key] = false;
      if (keyState[e.key]) {
        keyState[e.key].justPressed = false;
      }
    });
    
    // Utility Functions
    function generateUserId() {
      return 'tag_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function generateLobbyCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }
    
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      if (screenId) {
        const screen = document.getElementById(screenId);
        if (screen) screen.classList.add('active');
      }
    }
    
    function randomizePlatforms() {
      currentPlatforms = basePlatforms.map(platform => {
        const minWidth = platform.w - 20;
        const maxWidth = platform.w + 50;
        const newWidth = Math.floor(Math.random() * (maxWidth - minWidth + 1)) + minWidth;
        return {
          x: platform.x,
          y: platform.y,
          w: newWidth,
          h: platform.h
        };
      });
    }
    
    // User Management
    function checkExistingUser() {
      const userId = localStorage.getItem('arenaTagUserId');
      if (userId) {
        gameState.userId = userId;
        get(ref(database, 'tagUsers/' + userId)).then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            gameState.userName = userData.name;
            showScreen('homeScreen');
            document.getElementById('welcomeName').textContent = userData.name;
          } else {
            localStorage.removeItem('arenaTagUserId');
            showScreen('welcomeScreen');
          }
        }).catch(() => showScreen('welcomeScreen'));
      } else {
        showScreen('welcomeScreen');
      }
    }
    
    window.saveUserName = function() {
      const name = document.getElementById('nameInput').value.trim();
      if (!name) {
        alert('Please enter a name!');
        return;
      }
      
      const userId = generateUserId();
      gameState.userId = userId;
      gameState.userName = name;
      
      set(ref(database, 'tagUsers/' + userId), {
        name,
        createdAt: Date.now()
      }).then(() => {
        localStorage.setItem('arenaTagUserId', userId);
        document.getElementById('welcomeName').textContent = name;
        showScreen('homeScreen');
      }).catch(err => alert('Database error: ' + err.message));
    };
    
    // Lobby Management
    window.createLobby = function() {
      const lobbyCode = generateLobbyCode();
      gameState.currentLobby = lobbyCode;
      gameState.isHost = true;
      gameState.playerColor = PLAYER_COLORS[0];
      
      set(ref(database, `tagLobbies/${lobbyCode}`), {
        code: lobbyCode,
        host: gameState.userId,
        createdAt: Date.now(),
        gameStarted: false,
        gameDuration: 60,
        players: {
          [gameState.userId]: {
            name: gameState.userName,
            ready: false,
            color: gameState.playerColor,
            isIt: false,
            alive: true,
            x: 100,
            y: 100,
            vx: 0,
            vy: 0
          }
        }
      }).then(() => {
        onDisconnect(ref(database, `tagLobbies/${lobbyCode}/players/${gameState.userId}`)).remove();
        showLobbyScreen(lobbyCode);
      });
    };
    
    window.joinLobby = function() {
      const code = document.getElementById('joinCodeInput').value.trim();
      if (code.length !== 6) {
        alert('Enter 6-digit code!');
        return;
      }
      
      get(ref(database, `tagLobbies/${code}`)).then((snapshot) => {
        if (!snapshot.exists()) {
          alert('Lobby not found!');
          return;
        }
        
        const lobby = snapshot.val();
        const playerCount = Object.keys(lobby.players || {}).length;
        
        if (playerCount >= 10) {
          alert('Lobby full!');
          return;
        }
        
        gameState.currentLobby = code;
        gameState.isHost = false;
        gameState.playerColor = PLAYER_COLORS[playerCount % PLAYER_COLORS.length];
        
        const startPositions = [
          { x: 100, y: 100 },
          { x: 1000, y: 100 },
          { x: 100, y: 500 },
          { x: 1000, y: 500 },
          { x: 550, y: 300 },
          { x: 300, y: 200 },
          { x: 800, y: 200 },
          { x: 550, y: 500 },
          { x: 200, y: 350 },
          { x: 900, y: 350 }
        ];
        
        const pos = startPositions[playerCount % startPositions.length];
        
        update(ref(database, `tagLobbies/${code}/players/${gameState.userId}`), {
          name: gameState.userName,
          ready: false,
          color: gameState.playerColor,
          isIt: false,
          alive: true,
          x: pos.x,
          y: pos.y,
          vx: 0,
          vy: 0
        }).then(() => {
          onDisconnect(ref(database, `tagLobbies/${code}/players/${gameState.userId}`)).remove();
          showLobbyScreen(code);
        });
      });
    };
    
    function showLobbyScreen(code) {
      document.getElementById('lobbyCode').textContent = code;
      document.getElementById('readyBtn').disabled = false;
      document.getElementById('readyBtn').textContent = 'READY';
      
      // Only host can change duration
      const durationInput = document.getElementById('gameDuration');
      durationInput.disabled = !gameState.isHost;
      
      showScreen('lobbyScreen');
      
      lobbyListener = onValue(ref(database, `tagLobbies/${code}`), (snapshot) => {
        if (!snapshot.exists()) {
          alert('Lobby closed!');
          showScreen('homeScreen');
          return;
        }
        
        const lobby = snapshot.val();
        updatePlayerList(lobby.players);
        
        // Update duration display
        if (lobby.gameDuration && !gameState.isHost) {
          durationInput.value = lobby.gameDuration;
        }
        
        // Check if game started
        if (lobby.gameStarted && !gameState.isPlaying) {
          startMultiplayerGame(lobby);
        }
      });
    }
    
    function updatePlayerList(players) {
      const list = document.getElementById('playerList');
      list.innerHTML = '';
      
      Object.entries(players).forEach(([id, player]) => {
        const entry = document.createElement('div');
        const isCurrentUser = id === gameState.userId;
        entry.className = 'player-entry' + 
                         (player.ready ? ' ready' : '') +
                         (isCurrentUser ? ' current-user' : '');
        entry.innerHTML = `
          <div class="player-status">
            <div class="status-indicator"></div>
            <span style="color: ${player.color}; font-weight: 700;">‚¨§ ${player.name}</span>
          </div>
          <span style="font-weight: 700;">${player.ready ? '‚úì READY' : '‚úó NOT READY'}</span>
        `;
        list.appendChild(entry);
      });
    }
    
    window.toggleReady = function() {
      get(ref(database, `tagLobbies/${gameState.currentLobby}/players/${gameState.userId}`)).then((snapshot) => {
        const currentReady = snapshot.val().ready;
        update(ref(database, `tagLobbies/${gameState.currentLobby}/players/${gameState.userId}`), {
          ready: !currentReady
        }).then(() => {
          document.getElementById('readyBtn').textContent = !currentReady ? 'UNREADY' : 'READY';
          checkAllReady();
        });
      });
    };
    
    // Update duration when host changes it
    document.getElementById('gameDuration').addEventListener('change', function() {
      if (gameState.isHost && gameState.currentLobby) {
        const duration = parseInt(this.value);
        update(ref(database, `tagLobbies/${gameState.currentLobby}`), {
          gameDuration: duration
        });
      }
    });
    
    function checkAllReady() {
      if (!gameState.isHost) return;
      
      get(ref(database, `tagLobbies/${gameState.currentLobby}`)).then((snapshot) => {
        const lobby = snapshot.val();
        const players = lobby.players;
        const allReady = Object.values(players).every(p => p.ready);
        const playerCount = Object.keys(players).length;
        
        if (allReady && playerCount >= 2) {
          // Randomly assign who is "it"
          const playerIds = Object.keys(players);
          const randomIndex = Math.floor(Math.random() * playerIds.length);
          const itPlayerId = playerIds[randomIndex];
          
          const updates = {};
          updates[`tagLobbies/${gameState.currentLobby}/gameStarted`] = true;
          updates[`tagLobbies/${gameState.currentLobby}/gameStartTime`] = Date.now();
          
          playerIds.forEach(id => {
            updates[`tagLobbies/${gameState.currentLobby}/players/${id}/isIt`] = (id === itPlayerId);
            updates[`tagLobbies/${gameState.currentLobby}/players/${id}/ready`] = false;
          });
          
          // Generate and save platforms for this game
          randomizePlatforms();
          updates[`tagLobbies/${gameState.currentLobby}/platforms`] = currentPlatforms;
          
          update(ref(database), updates);
        } else if (allReady && playerCount < 2) {
          document.getElementById('waitingMessage').style.display = 'block';
        } else {
          document.getElementById('waitingMessage').style.display = 'none';
        }
      });
    }
    
    window.leaveLobby = function() {
      if (gameState.currentLobby) {
        remove(ref(database, `tagLobbies/${gameState.currentLobby}/players/${gameState.userId}`));
        
        // If host is leaving and game hasn't started, delete the lobby
        if (gameState.isHost) {
          get(ref(database, `tagLobbies/${gameState.currentLobby}`)).then((snapshot) => {
            if (snapshot.exists() && !snapshot.val().gameStarted) {
              remove(ref(database, `tagLobbies/${gameState.currentLobby}`));
            }
          });
        }
        
        if (lobbyListener) lobbyListener();
        gameState.currentLobby = null;
        gameState.isHost = false;
      }
      showScreen('homeScreen');
    };
    
    // Game Logic
    function startMultiplayerGame(lobby) {
      if (lobbyListener) lobbyListener();
      
      gameState.isPlaying = true;
      gameState.isPaused = false;
      gameState.timer = lobby.gameDuration || 60;
      gameState.startTime = lobby.gameStartTime;
      gameState.frameCount = 0;
      
      // Load platforms from lobby
      if (lobby.platforms) {
        currentPlatforms = lobby.platforms;
      } else {
        randomizePlatforms();
      }
      
      // Initialize local player
      const localPlayerData = lobby.players[gameState.userId];
      gameState.localPlayer = {
        x: localPlayerData.x,
        y: localPlayerData.y,
        vx: 0,
        vy: 0,
        w: 40,
        h: 40,
        color: localPlayerData.color,
        isIt: localPlayerData.isIt,
        jumps: 0,
        canDoubleJump: false,
        lastJumpTime: 0
      };
      
      showScreen(null);
      document.getElementById('hud').style.display = 'block';
      document.getElementById('pauseBtn').style.display = 'block';
      document.getElementById('timer').textContent = gameState.timer + 's';
      
      // Start countdown
      let countdown = 3;
      const countdownDisplay = document.getElementById('countdown');
      countdownDisplay.style.display = 'block';
      countdownDisplay.textContent = countdown;
      
      const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          countdownDisplay.textContent = countdown;
        } else {
          clearInterval(countdownInterval);
          countdownDisplay.textContent = "GO!";
          setTimeout(() => {
            countdownDisplay.style.display = 'none';
            startGameLoop();
          }, 500);
        }
      }, 1000);
      
      // Listen to other players
      onValue(ref(database, `tagLobbies/${gameState.currentLobby}/players`), (snapshot) => {
        if (!snapshot.exists()) return;
        
        otherPlayers = {};
        snapshot.forEach((child) => {
          if (child.key !== gameState.userId) {
            otherPlayers[child.key] = child.val();
          } else {
            // Update local player's "it" status from server
            gameState.localPlayer.isIt = child.val().isIt;
          }
        });
      });
    }
    
    function startGameLoop() {
      if (gameInterval) clearInterval(gameInterval);
      gameInterval = setInterval(gameLoop, 1000 / 60); // 60 FPS
    }
    
    function gameLoop() {
      if (!gameState.isPlaying || gameState.isPaused) return;
      
      gameState.frameCount++;
      
      // Update timer every second
      if (gameState.frameCount % 60 === 0) {
        const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
        const remaining = Math.max(0, gameState.timer - elapsed);
        document.getElementById('timer').textContent = remaining + 's';
        
        if (remaining === 0) {
          endGame();
          return;
        }
      }
      
      updateLocalPlayer();
      draw();
    }
    
    function updateLocalPlayer() {
      const p = gameState.localPlayer;
      
      // Horizontal movement
      if (keys['ArrowLeft'] || keys['a']) p.vx = -5;
      else if (keys['ArrowRight'] || keys['d']) p.vx = 5;
      else p.vx = 0;
      
      // Jumping
      const currentTime = Date.now();
      const jumpKey = keys['ArrowUp'] || keys['w'] || keys[' '];
      
      if (isGrounded(p)) {
        p.jumps = 0;
        p.canDoubleJump = true;
      }
      
      if ((keyState['ArrowUp'] && keyState['ArrowUp'].justPressed) ||
          (keyState['w'] && keyState['w'].justPressed) ||
          (keyState[' '] && keyState[' '].justPressed)) {
        if (p.jumps === 0 && isGrounded(p)) {
          p.vy = -12;
          p.jumps = 1;
          p.lastJumpTime = currentTime;
          
          if (keyState['ArrowUp']) keyState['ArrowUp'].justPressed = false;
          if (keyState['w']) keyState['w'].justPressed = false;
          if (keyState[' ']) keyState[' '].justPressed = false;
        } else if (p.jumps === 1 && p.canDoubleJump && (currentTime - p.lastJumpTime) <= 700) {
          p.vy = -12;
          p.jumps = 2;
          p.canDoubleJump = false;
          
          if (keyState['ArrowUp']) keyState['ArrowUp'].justPressed = false;
          if (keyState['w']) keyState['w'].justPressed = false;
          if (keyState[' ']) keyState[' '].justPressed = false;
        }
      }
      
      // Apply gravity
      p.vy += gravity;
      p.x += p.vx;
      p.y += p.vy;
      
      // Ground collision
      if (p.y + p.h > canvas.height) {
        p.y = canvas.height - p.h;
        p.vy = 0;
      }
      
      // Platform collision
      currentPlatforms.forEach(pl => {
        if (p.vy >= 0 && 
            p.x < pl.x + pl.w &&
            p.x + p.w > pl.x &&
            p.y + p.h >= pl.y &&
            p.y + p.h <= pl.y + pl.h + 5) {
          p.y = pl.y - p.h;
          p.vy = 0;
        }
      });
      
      // Keep inside canvas
      p.x = Math.max(0, Math.min(canvas.width - p.w, p.x));
      p.y = Math.min(canvas.height - p.h, p.y);
      
      // Check for tags
      checkTagCollisions();
      
      // Update position in database (throttled)
      if (gameState.frameCount % 3 === 0) {
        update(ref(database, `tagLobbies/${gameState.currentLobby}/players/${gameState.userId}`), {
          x: p.x,
          y: p.y,
          vx: p.vx,
          vy: p.vy,
          isIt: p.isIt
        });
      }
    }
    
    function isGrounded(p) {
      return (
        p.y + p.h >= canvas.height ||
        currentPlatforms.some(pl =>
          p.x < pl.x + pl.w &&
          p.x + p.w > pl.x &&
          p.y + p.h >= pl.y &&
          p.y + p.h <= pl.y + pl.h + 5
        )
      );
    }
    
    function checkTagCollisions() {
      const p1 = gameState.localPlayer;
      
      Object.entries(otherPlayers).forEach(([id, p2]) => {
        if (!p2.alive) return;
        
        const collision = (
          p1.x < p2.x + 40 &&
          p1.x + p1.w > p2.x &&
          p1.y < p2.y + 40 &&
          p1.y + p1.h > p2.y
        );
        
        if (collision) {
          if (p1.isIt && !p2.isIt) {
            // Local player tags other player
            p1.isIt = false;
            update(ref(database, `tagLobbies/${gameState.currentLobby}/players/${gameState.userId}`), {
              isIt: false
            });
            update(ref(database, `tagLobbies/${gameState.currentLobby}/players/${id}`), {
              isIt: true
            });
          } else if (!p1.isIt && p2.isIt) {
            // Other player tags local player
            p1.isIt = true;
            update(ref(database, `tagLobbies/${gameState.currentLobby}/players/${gameState.userId}`), {
              isIt: true
            });
            update(ref(database, `tagLobbies/${gameState.currentLobby}/players/${id}`), {
              isIt: false
            });
          }
        }
      });
    }
    
    function draw() {
      // Clear canvas
      ctx.fillStyle = '#1a1a3e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw platforms with glow effect
      currentPlatforms.forEach(pl => {
        // Platform glow
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#00ffff';
        ctx.fillStyle = '#2a4a6a';
        ctx.fillRect(pl.x, pl.y, pl.w, pl.h);
        
        // Platform highlight
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#3a5a7a';
        ctx.fillRect(pl.x, pl.y, pl.w, 3);
      });
      
      // Draw other players
      Object.entries(otherPlayers).forEach(([id, player]) => {
        if (!player.alive) return;
        drawPlayer(player.x, player.y, player.color, player.isIt, player.name);
      });
      
      // Draw local player
      const p = gameState.localPlayer;
      drawPlayer(p.x, p.y, p.color, p.isIt, gameState.userName + ' (You)');
    }
    
    function drawPlayer(x, y, color, isIt, name) {
      const w = 40;
      const h = 40;
      
      // Shadow
      ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
      ctx.fillRect(x + 4, y + 4, w, h);
      
      // Player body with gradient
      const gradient = ctx.createLinearGradient(x, y, x, y + h);
      gradient.addColorStop(0, color);
      gradient.addColorStop(1, shadeColor(color, -20));
      ctx.fillStyle = gradient;
      
      // Add glow for "it" player
      if (isIt) {
        ctx.shadowBlur = 25;
        ctx.shadowColor = '#ffd700';
      } else {
        ctx.shadowBlur = 10;
        ctx.shadowColor = color;
      }
      
      // Rounded rectangle body
      ctx.beginPath();
      ctx.roundRect(x, y, w, h, 8);
      ctx.fill();
      ctx.shadowBlur = 0;
      
      // Eyes
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(x + 12, y + 15, 4, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x + 28, y + 15, 4, 0, Math.PI * 2);
      ctx.fill();
      
      // Eye highlights
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(x + 13, y + 14, 2, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x + 29, y + 14, 2, 0, Math.PI * 2);
      ctx.fill();
      
      // Smile
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x + 20, y + 25, 8, 0.2, Math.PI - 0.2);
      ctx.stroke();
      
      // "IT" indicator
      if (isIt) {
        ctx.fillStyle = '#ffd700';
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#ffd700';
        ctx.beginPath();
        ctx.arc(x + w/2, y - 12, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
        
        ctx.fillStyle = '#000';
        ctx.font = 'bold 10px Orbitron';
        ctx.textAlign = 'center';
        ctx.fillText('IT', x + w/2, y - 9);
      }
      
      // Name tag
      ctx.fillStyle = color;
      ctx.font = '12px Rajdhani';
      ctx.textAlign = 'center';
      ctx.shadowBlur = 5;
      ctx.shadowColor = '#000';
      ctx.fillText(name, x + w/2, y - 20);
      ctx.shadowBlur = 0;
    }
    
    function shadeColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255))
        .toString(16).slice(1);
    }
    
    function endGame() {
      gameState.isPlaying = false;
      if (gameInterval) clearInterval(gameInterval);
      
      // Find who is "it"
      let winner = '';
      if (gameState.localPlayer.isIt) {
        winner = `${gameState.userName} (You) was IT!`;
      } else {
        const itPlayer = Object.entries(otherPlayers).find(([id, p]) => p.isIt);
        if (itPlayer) {
          winner = `${itPlayer[1].name} was IT!`;
        }
      }
      
      document.getElementById('winner-text').textContent = winner;
      document.getElementById('gameOver').style.display = 'block';
      document.getElementById('pauseBtn').style.display = 'none';
    }
    
    window.continueAfterGame = function() {
      document.getElementById('gameOver').style.display = 'none';
      
      // Reset players in lobby
      if (gameState.currentLobby) {
        update(ref(database, `tagLobbies/${gameState.currentLobby}/players/${gameState.userId}`), {
          ready: false
        });
        
        // Only host can reset game
        if (gameState.isHost) {
          update(ref(database, `tagLobbies/${gameState.currentLobby}`), {
            gameStarted: false
          });
        }
        
        showLobbyScreen(gameState.currentLobby);
      }
    };
    
    // Pause functionality
    document.getElementById('pauseBtn').addEventListener('click', () => {
      gameState.isPaused = true;
      if (gameInterval) clearInterval(gameInterval);
      document.getElementById('pause-menu').style.display = 'block';
    });
    
    window.resumeGame = function() {
      gameState.isPaused = false;
      document.getElementById('pause-menu').style.display = 'none';
      startGameLoop();
    };
    
    window.leaveGame = function() {
      gameState.isPlaying = false;
      if (gameInterval) clearInterval(gameInterval);
      document.getElementById('pause-menu').style.display = 'none';
      document.getElementById('gameOver').style.display = 'none';
      document.getElementById('hud').style.display = 'none';
      document.getElementById('pauseBtn').style.display = 'none';
      
      if (gameState.currentLobby) {
        update(ref(database, `tagLobbies/${gameState.currentLobby}/players/${gameState.userId}`), {
          ready: false,
          alive: false
        });
        showLobbyScreen(gameState.currentLobby);
      }
    };
    
    // Initialize
    checkExistingUser();
  </script>
</body>
</html>
