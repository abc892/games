<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tag Game - Online Party</title>
  
  <!-- Import Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 500px;
      padding: 30px;
      text-align: center;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .screen {
      display: none;
    }
    
    .active {
      display: block;
    }
    
    .btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
      transition: all 0.3s;
      width: 200px;
    }
    
    .btn:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #2196F3;
    }
    
    .btn-secondary:hover {
      background: #0b7dda;
    }
    
    .btn-danger {
      background: #f44336;
    }
    
    .btn-danger:hover {
      background: #d32f2f;
    }
    
    .input-group {
      margin: 20px 0;
    }
    
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin: 10px 0;
    }
    
    input:focus {
      border-color: #4CAF50;
      outline: none;
    }
    
    .party-id {
      font-size: 48px;
      font-weight: bold;
      color: #4CAF50;
      margin: 20px 0;
      letter-spacing: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .player-list {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      text-align: left;
    }
    
    .player {
      padding: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    
    .player:last-child {
      border-bottom: none;
    }
    
    .admin-badge {
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .settings-group {
      margin: 20px 0;
      text-align: left;
    }
    
    .settings-group label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
      color: #555;
    }
    
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .status {
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .hidden {
      display: none;
    }
    
    .leave-btn {
      background: transparent;
      color: #f44336;
      border: 1px solid #f44336;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .leave-btn:hover {
      background: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Main Menu Screen -->
    <div id="main-menu" class="screen active">
      <h1>üèÉ Tag Game</h1>
      <p class="subtitle">Choose your game mode</p>
      
      <button class="btn" onclick="showScreen('single-player-menu')">Single Player</button>
      <button class="btn" onclick="showScreen('party-menu')">Online Party</button>
      <button class="btn btn-secondary" onclick="window.location.href='index.html'">Back to Game Hub</button>
    </div>
    
    <!-- Single Player Menu -->
    <div id="single-player-menu" class="screen">
      <h1>Single Player</h1>
      <p class="subtitle">Play against computer</p>
      
      <div class="input-group">
        <input type="text" id="player-name" placeholder="Enter your name" value="Player">
      </div>
      
      <button class="btn" onclick="startSinglePlayer()">Start Game</button>
      <button class="btn btn-secondary" onclick="showScreen('main-menu')">Back</button>
    </div>
    
    <!-- Party Menu -->
    <div id="party-menu" class="screen">
      <h1>Online Party</h1>
      <p class="subtitle">Play with friends online</p>
      
      <button class="btn" onclick="showScreen('create-party')">Create Party</button>
      <button class="btn btn-secondary" onclick="showScreen('join-party')">Join Party</button>
      <button class="btn" onclick="showScreen('main-menu')">Back</button>
    </div>
    
    <!-- Create Party Screen -->
    <div id="create-party" class="screen">
      <h1>Create Party</h1>
      <p class="subtitle">You'll be the party admin</p>
      
      <div class="input-group">
        <input type="text" id="admin-name" placeholder="Enter your name" value="Player">
      </div>
      
      <button class="btn" onclick="createParty()">Create Party</button>
      <button class="btn" onclick="showScreen('party-menu')">Back</button>
      
      <div id="party-created" class="hidden">
        <div class="party-id" id="party-code">----</div>
        <p>Share this code with friends to join your party</p>
        <div id="create-status" class="status status-info">Creating party...</div>
        
        <button class="btn" onclick="showScreen('party-lobby')">Go to Lobby</button>
      </div>
    </div>
    
    <!-- Join Party Screen -->
    <div id="join-party" class="screen">
      <h1>Join Party</h1>
      <p class="subtitle">Enter the 4-digit party code</p>
      
      <div class="input-group">
        <input type="text" id="party-code-input" placeholder="Enter 4-digit code" maxlength="4">
        <input type="text" id="member-name" placeholder="Enter your name" value="Player">
      </div>
      
      <button class="btn" onclick="joinParty()">Join Party</button>
      <button class="btn" onclick="showScreen('party-menu')">Back</button>
      
      <div id="join-status"></div>
    </div>
    
    <!-- Party Lobby Screen -->
    <div id="party-lobby" class="screen">
      <h1>Party Lobby</h1>
      <p class="subtitle" id="party-code-display">Party Code: ----</p>
      
      <div class="player-list" id="players-list">
        <div class="player">
          <span>Loading players...</span>
        </div>
      </div>
      
      <div class="settings-group" id="admin-settings">
        <h3>Game Settings</h3>
        <label for="game-time">Game Time (seconds)</label>
        <select id="game-time">
          <option value="60">1 minute</option>
          <option value="120" selected>2 minutes</option>
          <option value="180">3 minutes</option>
          <option value="300">5 minutes</option>
        </select>
        
        <label for="background">Background</label>
        <select id="background">
          <option value="forest" selected>Forest</option>
          <option value="city">City</option>
          <option value="beach">Beach</option>
          <option value="space">Space</option>
        </select>
        
        <label for="powerups">Power-ups</label>
        <select id="powerups">
          <option value="enabled" selected>Enabled</option>
          <option value="disabled">Disabled</option>
        </select>
      </div>
      
      <div class="settings-group" id="member-settings">
        <h3>Game Settings</h3>
        <div id="settings-display">
          <p>Game Time: <span id="display-time">120</span> seconds</p>
          <p>Background: <span id="display-bg">Forest</span></p>
          <p>Power-ups: <span id="display-powerups">Enabled</span></p>
        </div>
      </div>
      
      <button class="btn" id="start-game-btn" onclick="startGame()">Start Game</button>
      <button class="btn btn-danger" onclick="leaveParty()">Leave Party</button>
      
      <div id="lobby-status"></div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAwEy-sJx7E61BA6VmBfIFMZsjuAj8RK5g",
      authDomain: "games-c3e27.firebaseapp.com",
      databaseURL: "https://games-c3e27-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "games-c3e27",
      storageBucket: "games-c3e27.firebasestorage.app",
      messagingSenderId: "193027632069",
      appId: "1:193027632069:web:b559c3b10011bc6982b9ac"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // User and Party Variables
    let userId = localStorage.getItem('gameHubUserId') || 'user_' + Math.random().toString(36).substr(2, 16) + '_' + Date.now();
    let currentPartyId = null;
    let isAdmin = false;
    let partyRef = null;
    let userRef = null;
    
    // Save user ID to localStorage
    localStorage.setItem('gameHubUserId', userId);
    
    // Screen Navigation
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
    }
    
    // Generate a 4-digit party code
    function generatePartyCode() {
      return Math.floor(1000 + Math.random() * 9000).toString();
    }
    
    // Create a new party
    function createParty() {
      const playerName = document.getElementById('admin-name').value || 'Player';
      const partyCode = generatePartyCode();
      
      // Check if party code already exists
      database.ref('parties/' + partyCode).once('value').then(snapshot => {
        if (snapshot.exists()) {
          // Code exists, generate a new one
          createParty();
          return;
        }
        
        // Create the party
        const partyData = {
          code: partyCode,
          admin: userId,
          players: {
            [userId]: {
              name: playerName,
              joinedAt: Date.now(),
              isAdmin: true
            }
          },
          settings: {
            gameTime: 120,
            background: 'forest',
            powerups: 'enabled'
          },
          status: 'waiting',
          createdAt: Date.now()
        };
        
        database.ref('parties/' + partyCode).set(partyData)
          .then(() => {
            currentPartyId = partyCode;
            isAdmin = true;
            
            // Show party code
            document.getElementById('party-code').textContent = partyCode;
            document.getElementById('party-created').classList.remove('hidden');
            document.getElementById('create-status').textContent = 'Party created successfully!';
            document.getElementById('create-status').className = 'status status-success';
            
            // Set up real-time listeners
            setupPartyListeners(partyCode);
          })
          .catch(error => {
            document.getElementById('create-status').textContent = 'Error creating party: ' + error.message;
            document.getElementById('create-status').className = 'status status-error';
          });
      });
    }
    
    // Join an existing party
    function joinParty() {
      const partyCode = document.getElementById('party-code-input').value;
      const playerName = document.getElementById('member-name').value || 'Player';
      
      if (!partyCode || partyCode.length !== 4) {
        showStatus('join-status', 'Please enter a valid 4-digit code', 'error');
        return;
      }
      
      // Check if party exists
      database.ref('parties/' + partyCode).once('value').then(snapshot => {
        if (!snapshot.exists()) {
          showStatus('join-status', 'Party not found. Please check the code.', 'error');
          return;
        }
        
        const partyData = snapshot.val();
        
        if (partyData.status !== 'waiting') {
          showStatus('join-status', 'This party is no longer accepting players.', 'error');
          return;
        }
        
        // Join the party
        currentPartyId = partyCode;
        isAdmin = false;
        
        const updates = {};
        updates[`parties/${partyCode}/players/${userId}`] = {
          name: playerName,
          joinedAt: Date.now(),
          isAdmin: false
        };
        
        database.ref().update(updates)
          .then(() => {
            showStatus('join-status', 'Joined party successfully!', 'success');
            setTimeout(() => {
              showScreen('party-lobby');
              setupPartyListeners(partyCode);
            }, 1000);
          })
          .catch(error => {
            showStatus('join-status', 'Error joining party: ' + error.message, 'error');
          });
      });
    }
    
    // Set up real-time listeners for party changes
    function setupPartyListeners(partyCode) {
      partyRef = database.ref('parties/' + partyCode);
      
      // Listen for player changes
      partyRef.child('players').on('value', snapshot => {
        updatePlayersList(snapshot.val());
      });
      
      // Listen for settings changes
      partyRef.child('settings').on('value', snapshot => {
        updateSettingsDisplay(snapshot.val());
      });
      
      // Listen for game start
      partyRef.child('status').on('value', snapshot => {
        if (snapshot.val() === 'playing') {
          startPartyGame();
        }
      });
      
      // Update party code display
      document.getElementById('party-code-display').textContent = 'Party Code: ' + partyCode;
    }
    
    // Update the players list in the lobby
    function updatePlayersList(players) {
      const playersList = document.getElementById('players-list');
      playersList.innerHTML = '';
      
      if (!players) {
        playersList.innerHTML = '<div class="player">No players in party</div>';
        return;
      }
      
      // Convert to array and sort by join time
      const playersArray = Object.entries(players).map(([id, data]) => ({
        id,
        ...data
      })).sort((a, b) => a.joinedAt - b.joinedAt);
      
      playersArray.forEach(player => {
        const playerElement = document.createElement('div');
        playerElement.className = 'player';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = player.name;
        
        const statusSpan = document.createElement('span');
        if (player.isAdmin) {
          statusSpan.innerHTML = '<span class="admin-badge">Admin</span>';
        }
        
        playerElement.appendChild(nameSpan);
        playerElement.appendChild(statusSpan);
        playersList.appendChild(playerElement);
      });
      
      // Update admin settings visibility
      const isUserAdmin = players[userId] && players[userId].isAdmin;
      document.getElementById('admin-settings').classList.toggle('hidden', !isUserAdmin);
      document.getElementById('member-settings').classList.toggle('hidden', isUserAdmin);
      document.getElementById('start-game-btn').classList.toggle('hidden', !isUserAdmin);
    }
    
    // Update settings display for non-admin players
    function updateSettingsDisplay(settings) {
      if (!settings) return;
      
      document.getElementById('display-time').textContent = settings.gameTime;
      document.getElementById('display-bg').textContent = 
        settings.background.charAt(0).toUpperCase() + settings.background.slice(1);
      document.getElementById('display-powerups').textContent = 
        settings.powerups === 'enabled' ? 'Enabled' : 'Disabled';
      
      // Update admin controls if user is admin
      if (isAdmin) {
        document.getElementById('game-time').value = settings.gameTime;
        document.getElementById('background').value = settings.background;
        document.getElementById('powerups').value = settings.powerups;
      }
    }
    
    // Update settings (admin only)
    function updateSettings() {
      if (!isAdmin || !currentPartyId) return;
      
      const settings = {
        gameTime: parseInt(document.getElementById('game-time').value),
        background: document.getElementById('background').value,
        powerups: document.getElementById('powerups').value
      };
      
      database.ref('parties/' + currentPartyId + '/settings').update(settings);
    }
    
    // Start the game (admin only)
    function startGame() {
      if (!isAdmin || !currentPartyId) return;
      
      // Update settings first
      updateSettings();
      
      // Change party status to playing
      database.ref('parties/' + currentPartyId).update({
        status: 'playing'
      });
    }
    
    // Start the actual game with party settings
    function startPartyGame() {
      // Get final settings
      partyRef.child('settings').once('value').then(snapshot => {
        const settings = snapshot.val();
        
        // Store settings for the game
        localStorage.setItem('partyGameSettings', JSON.stringify({
          ...settings,
          isMultiplayer: true,
          partyCode: currentPartyId
        }));
        
        // Redirect to game screen (you'll need to create this)
        alert('Game starting with settings: ' + JSON.stringify(settings));
        // window.location.href = 'tag-game.html';
      });
    }
    
    // Leave the party
    function leaveParty() {
      if (!currentPartyId) {
        showScreen('party-menu');
        return;
      }
      
      // Remove user from party
      database.ref('parties/' + currentPartyId + '/players/' + userId).remove()
        .then(() => {
          // Check if party is empty
          partyRef.child('players').once('value').then(snapshot => {
            const players = snapshot.val();
            
            if (!players || Object.keys(players).length === 0) {
              // Delete empty party
              partyRef.remove();
            } else if (isAdmin) {
              // Assign new admin (oldest remaining player)
              const playersArray = Object.entries(players).map(([id, data]) => ({
                id,
                ...data
              })).sort((a, b) => a.joinedAt - b.joinedAt);
              
              if (playersArray.length > 0) {
                const newAdminId = playersArray[0].id;
                partyRef.child('players/' + newAdminId + '/isAdmin').set(true);
                partyRef.child('admin').set(newAdminId);
              }
            }
          });
          
          // Clean up
          currentPartyId = null;
          isAdmin = false;
          if (partyRef) {
            partyRef.off();
            partyRef = null;
          }
          
          showScreen('party-menu');
        })
        .catch(error => {
          console.error('Error leaving party:', error);
          showScreen('party-menu');
        });
    }
    
    // Single player game
    function startSinglePlayer() {
      const playerName = document.getElementById('player-name').value || 'Player';
      
      // Store settings for single player
      localStorage.setItem('partyGameSettings', JSON.stringify({
        gameTime: 120,
        background: 'forest',
        powerups: 'enabled',
        isMultiplayer: false,
        playerName: playerName
      }));
      
      // Redirect to game screen
      alert('Starting single player game as ' + playerName);
      // window.location.href = 'tag-game.html';
    }
    
    // Helper function to show status messages
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = 'status status-' + 
        (type === 'success' ? 'success' : type === 'error' ? 'error' : 'info');
    }
    
    // Set up event listeners for admin settings changes
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('game-time').addEventListener('change', updateSettings);
      document.getElementById('background').addEventListener('change', updateSettings);
      document.getElementById('powerups').addEventListener('change', updateSettings);
      
      // Set default username if available
      const savedUsername = localStorage.getItem('gameHubUsername');
      if (savedUsername) {
        document.getElementById('admin-name').value = savedUsername;
        document.getElementById('member-name').value = savedUsername;
        document.getElementById('player-name').value = savedUsername;
      }
      
      // Save username when changed
      const nameInputs = document.querySelectorAll('input[type="text"]');
      nameInputs.forEach(input => {
        input.addEventListener('change', function() {
          localStorage.setItem('gameHubUsername', this.value);
        });
      });
    });
    
    // Clean up when leaving the page
    window.addEventListener('beforeunload', function() {
      if (currentPartyId) {
        leaveParty();
      }
    });
  </script>
</body>
</html>
