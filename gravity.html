<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gravity Ball Multiplayer</title>
<style>
body { margin:0; background:black; overflow:hidden; }
canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAwEy-sJx7E61BA6VmBfIFMZsjuAj8RK5g",
  authDomain: "games-c3e27.firebaseapp.com",
  databaseURL: "https://games-c3e27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "games-c3e27",
  storageBucket: "games-c3e27.firebasestorage.app",
  messagingSenderId: "193027632069",
  appId: "1:193027632069:web:b559c3b10011bc6982b9ac"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

/* ================= CONSTANTS ================= */
const G = 0.15;
const thrust = 0.1;
const keys = {};
const PLAYER_RADIUS = 8;

/* ================= PLAYER ID + NAME ================= */
const playerId = localStorage.getItem("gravityPlayerId") ||
  ("p_" + Math.random().toString(36).slice(2));
localStorage.setItem("gravityPlayerId", playerId);

const playerName = prompt("Enter your name") || "Player";

/* ================= PLAYER ================= */
const player = {
  x: 0, y: 0, vx: 0, vy: 0, angle: 0,
  radius: PLAYER_RADIUS,
  name: playerName
};

/* ================= WORLD ================= */
let planets = [];
let blackHole = null;

/* ================= WORLD GENERATION ================= */
function generateWorld(seed){
  const rand = mulberry32(seed);
  planets = [];

  for(let i=0;i<10;i++){
    let r = 30 + rand()*90;
    let x = rand()*3000 - 1500;
    let y = rand()*3000 - 1500;
    planets.push({
      x,y,
      radius:r,
      mass: r*r*r*0.07,
      color: `hsl(${rand()*360},80%,60%)`
    });
  }

  blackHole = {
    x: rand()*6000 - 3000,
    y: rand()*6000 - 3000,
    radius: 100,
    mass: 800000,
    angle: 0
  };
}

/* ================= INIT WORLD ================= */
const worldRef = db.ref("gravityGame/world");
worldRef.once("value", snap=>{
  if(!snap.exists()){
    const seed = Math.floor(Math.random()*1e9);
    generateWorld(seed);
    worldRef.set({ seed });
  } else {
    generateWorld(snap.val().seed);
  }
});

/* ================= PLAYERS ================= */
const players = {};
const playerRef = db.ref("gravityGame/players/"+playerId);

playerRef.set({
  ...player,
  lastSeen: Date.now()
});
playerRef.onDisconnect().remove();

db.ref("gravityGame/players").on("value", snap=>{
  Object.assign(players, snap.val() || {});
});

/* ================= INPUT ================= */
addEventListener("keydown", e=>keys[e.key]=true);
addEventListener("keyup", e=>keys[e.key]=false);

/* ================= PHYSICS ================= */
function applyGravity(obj){
  for(let p of planets.concat([blackHole])){
    const dx = p.x - obj.x;
    const dy = p.y - obj.y;
    const dist = Math.max(1, Math.hypot(dx,dy));
    const accel = G*p.mass/(dist*dist);
    obj.vx += accel*(dx/dist);
    obj.vy += accel*(dy/dist);
  }
}

function playerCollision(){
  for(let id in players){
    if(id===playerId) continue;
    const o = players[id];
    const dx = o.x - player.x;
    const dy = o.y - player.y;
    const d = Math.hypot(dx,dy);
    if(d < PLAYER_RADIUS*2){
      const nx = dx/d, ny = dy/d;
      player.vx -= nx*0.1;
      player.vy -= ny*0.1;
    }
  }
}

/* ================= UPDATE ================= */
function update(){
  if(keys.ArrowLeft) player.angle -= 0.05;
  if(keys.ArrowRight) player.angle += 0.05;
  if(keys.ArrowUp){
    player.vx += Math.cos(player.angle)*thrust;
    player.vy += Math.sin(player.angle)*thrust;
  }

  applyGravity(player);
  playerCollision();

  player.x += player.vx;
  player.y += player.vy;

  playerRef.update({
    x:player.x, y:player.y,
    vx:player.vx, vy:player.vy,
    angle:player.angle,
    name:player.name,
    lastSeen:Date.now()
  });
}

/* ================= DRAW ================= */
function draw(){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const cx = canvas.width/2;
  const cy = canvas.height/2;

  // planets
  for(let p of planets){
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(p.x-player.x+cx,p.y-player.y+cy,p.radius,0,Math.PI*2);
    ctx.fill();
  }

  // black hole
  ctx.fillStyle="rgba(80,0,120,0.4)";
  ctx.beginPath();
  ctx.arc(blackHole.x-player.x+cx,blackHole.y-player.y+cy,blackHole.radius*2,0,Math.PI*2);
  ctx.fill();
  ctx.fillStyle="black";
  ctx.beginPath();
  ctx.arc(blackHole.x-player.x+cx,blackHole.y-player.y+cy,blackHole.radius,0,Math.PI*2);
  ctx.fill();

  // other players
  for(let id in players){
    const p = players[id];
    const x = p.x-player.x+cx;
    const y = p.y-player.y+cy;
    ctx.fillStyle = id===playerId?"white":"red";
    ctx.beginPath();
    ctx.arc(x,y,PLAYER_RADIUS,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="white";
    ctx.fillText(p.name,x-10,y-15);
  }
}

/* ================= LOOP ================= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ================= RANDOM ================= */
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296}}
</script>
</body>
</html>
