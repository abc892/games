<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gravity Ball Multiplayer</title>
<style>
  body { margin:0; background:black; overflow:hidden; }
  canvas { display:block; }
  #nameOverlay {
    position:fixed;
    inset:0;
    background:black;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10;
  }
  #nameInput {
    font-size:20px;
    padding:10px;
    border-radius:8px;
    border:none;
    outline:none;
  }
</style>
</head>
<body>

<!-- Name entry -->
<div id="nameOverlay">
  <input id="nameInput" placeholder="Enter your name & press Enter">
</div>

<canvas id="game"></canvas>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAwEy-sJx7E61BA6VmBfIFMZsjuAj8RK5g",
  authDomain: "games-c3e27.firebaseapp.com",
  databaseURL: "https://games-c3e27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "games-c3e27",
  storageBucket: "games-c3e27.firebasestorage.app",
  messagingSenderId: "193027632069",
  appId: "1:193027632069:web:b559c3b10011bc6982b9ac"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// --- Variables ---
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const G = 0.15, thrust = 0.1, keys = {};
const miniMap = { width:200, height:150, padding:10 };
const starSectorSize = 400;

let playerName = null;
let playerId = 'player_' + Math.random().toString(36).substr(2,8) + Date.now();
let playersData = {};
let planets = [], blackHole = null;

// --- Name entry ---
const nameOverlay = document.getElementById("nameOverlay");
const nameInput = document.getElementById("nameInput");
nameInput.focus();

nameInput.addEventListener("keydown", e => {
  if(e.key === "Enter" && nameInput.value.trim()){
    playerName = nameInput.value.trim();
    nameOverlay.remove();
    startGame();
  }
});

// --- Utility ---
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return ((t^t>>>14)>>>0)/4294967296;}}

// --- Generate world if first player ---
function generateWorld(){
  // --- Planets ---
  const colors = ["orange","red","green","blue","purple","yellow","pink","cyan","lime","magenta"];
  planets = [];
  let attempts = 0;
  while(planets.length < 10 && attempts < 5000){
    attempts++;
    const radius = 30 + Math.random()*90;
    const x = Math.random()*3000 - 1500;
    const y = Math.random()*3000 - 1500;
    const color = colors[Math.floor(Math.random()*colors.length)];
    let ok = true;
    for(let p of planets){
      const dx=x-p.x, dy=y-p.y, dist=Math.sqrt(dx*dx+dy*dy);
      if(dist < radius+p.radius+50){ ok=false; break; }
    }
    if(Math.sqrt(x*x+y*y)<200) ok=false;
    if(ok) planets.push({x,y,radius,mass:Math.pow(radius,3)*0.07,color});
  }

  // --- Black Hole ---
  let ok=false;
  while(!ok){
    const x = Math.random()*6000 - 3000;
    const y = Math.random()*6000 - 3000;
    if(Math.sqrt(x*x+y*y) > 4000){
      blackHole = {x,y,radius:100,mass:800000,color:"black",angle:0,particles:[]};
      for(let i=0;i<100;i++){
        blackHole.particles.push({r:blackHole.radius+Math.random()*150,angle:Math.random()*Math.PI*2,speed:0.002+Math.random()*0.004,size:1+Math.random()*2});
      }
      ok=true;
    }
  }

  // Save world in Firebase
  database.ref('gravity/world').set({planets,blackHole});
}

// --- Load world ---
function loadWorld(callback){
  database.ref('gravity/world').once('value', snapshot => {
    const data = snapshot.val();
    if(data){ planets=data.planets; blackHole=data.blackHole; callback(); }
    else{ generateWorld(); callback(); }
  });
}

// --- Player ---
const player = {x:0,y:0,vx:0,vy:0,angle:0,radius:8,name:""};

function startGame(){
  // Set initial player data
  player.x = 0; player.y = 0;
  player.name = playerName;

  // Load world first
  loadWorld(()=>{

    // --- Firebase player presence ---
    const myRef = database.ref('gravity/players/' + playerId);
    myRef.set({x:player.x,y:player.y,vx:player.vx,vy:player.vy,angle:player.angle,name:player.name});
    myRef.onDisconnect().remove();

    // Update loop to sync
    setInterval(()=>{
      myRef.update({x:player.x,y:player.y,vx:player.vx,vy:player.vy,angle:player.angle});
    },1);

    // Listen for other players
    database.ref('gravity/players').on('value', snapshot=>{
      playersData = snapshot.val() || {};
    });

    // Start game loop
    requestAnimationFrame(loop);
  });
}

// --- Input ---
window.addEventListener("keydown", e=>keys[e.key]=true);
window.addEventListener("keyup", e=>keys[e.key]=false);

// --- Physics ---
function applyGravity(){
  for(let p of planets.concat([blackHole])){
    let dx = p.x - player.x;
    let dy = p.y - player.y;
    let dist = Math.sqrt(dx*dx + dy*dy); if(dist<0.1) dist=0.1;
    const R=p.radius+player.radius;
    const nx=dx/dist, ny=dy/dist;
    const accel=dist>R? G*p.mass/(dist*dist) : G*p.mass*dist/(R*R*R);
    player.vx += accel*nx; player.vy += accel*ny;
    if(dist<R && p!==blackHole){
      player.x = p.x - nx*R; player.y = p.y - ny*R;
      const vDotN = player.vx*nx + player.vy*ny;
      if(vDotN>0){ player.vx-=vDotN*nx; player.vy-=vDotN*ny; }
    }
  }

  // --- Player collision ---
  for(let id in playersData){
    if(id===playerId) continue;
    const op=playersData[id];
    let dx=op.x-player.x, dy=op.y-player.y;
    let dist=Math.sqrt(dx*dx+dy*dy);
    let minDist=player.radius+8;
    if(dist<minDist && dist>0){
      let nx=dx/dist, ny=dy/dist, overlap=minDist-dist;
      player.x-=nx*overlap*0.5;
      player.y-=ny*overlap*0.5;
    }
  }
}

function updatePlayer(){
  if(keys["ArrowLeft"]) player.angle-=0.05;
  if(keys["ArrowRight"]) player.angle+=0.05;
  if(keys["ArrowUp"]){ player.vx+=Math.cos(player.angle)*thrust; player.vy+=Math.sin(player.angle)*thrust; }
  if(keys["m"]){ player.vx*=0.98; player.vy*=0.98; }
  applyGravity();
  player.x+=player.vx; player.y+=player.vy;
}

// --- Infinite stars ---
function drawStars(){
  const centerX=canvas.width/2, centerY=canvas.height/2;
  const startX=Math.floor((player.x-centerX)/starSectorSize)*starSectorSize;
  const startY=Math.floor((player.y-centerY)/starSectorSize)*starSectorSize;
  const endX=Math.floor((player.x+centerX)/starSectorSize)*starSectorSize;
  const endY=Math.floor((player.y+centerY)/starSectorSize)*starSectorSize;
  for(let sx=startX;sx<=endX;sx+=starSectorSize){
    for(let sy=startY;sy<=endY;sy+=starSectorSize){
      const seed = sx*73856093 ^ sy*19349663;
      const rand = mulberry32(seed);
      const starsInSector = 10 + Math.floor(rand()*15);
      for(let i=0;i<starsInSector;i++){
        const starX = sx + rand()*starSectorSize;
        const starY = sy + rand()*starSectorSize;
        const radius = 0.5 + rand()*1.5;
        const brightness = 0.2 + rand()*0.5;
        const screenX = starX - player.x + centerX;
        const screenY = starY - player.y + centerY;
        if(screenX>=0 && screenX<=canvas.width && screenY>=0 && screenY<=canvas.height){
          ctx.fillStyle=`rgba(255,255,255,${brightness})`;
          ctx.beginPath();
          ctx.arc(screenX,screenY,radius,0,Math.PI*2);
          ctx.fill();
        }
      }
    }
  }
}

// --- Draw ---
function drawPlayer(pl){
  const centerX=canvas.width/2, centerY=canvas.height/2;
  const px = (pl===player)? centerX : pl.x-player.x+centerX;
  const py = (pl===player)? centerY : pl.y-player.y+centerY;
  ctx.save();
  ctx.translate(px,py);
  ctx.rotate(pl.angle);
  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(0,0,player.radius,0,Math.PI*2);
  ctx.fill();
  ctx.strokeStyle="cyan";
  ctx.beginPath();
  ctx.moveTo(0,0); ctx.lineTo(15,0); ctx.stroke();
  ctx.restore();

  // Name
  ctx.fillStyle="white";
  ctx.font="14px Arial";
  ctx.textAlign="center";
  ctx.fillText(pl.name,px,py-player.radius-10);
}

function drawPlanets(){
  const centerX=canvas.width/2, centerY=canvas.height/2;
  for(let p of planets){
    const screenX=p.x-player.x+centerX;
    const screenY=p.y-player.y+centerY;
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(screenX,screenY,p.radius,0,Math.PI*2);
    ctx.fill();
  }

  // Black Hole visuals
  const bhX = blackHole.x - player.x + centerX;
  const bhY = blackHole.y - player.y + centerY;
  blackHole.angle += 0.005;
  for(let i=0;i<5;i++){
    ctx.strokeStyle = `rgba(150,0,200,${0.1-i*0.015})`;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(bhX,bhY,blackHole.radius*(1.2+i*0.3),blackHole.angle,blackHole.angle+Math.PI*1.5);
    ctx.stroke();
  }
  const gradient = ctx.createRadialGradient(bhX,bhY,blackHole.radius*0.5,bhX,bhY,blackHole.radius*3);
  gradient.addColorStop(0,"rgba(0,0,0,1)");
  gradient.addColorStop(0.3,"rgba(50,0,50,0.3)");
  gradient.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle = gradient;
  ctx.beginPath();
  ctx.arc(bhX,bhY,blackHole.radius*3,0,Math.PI*2);
  ctx.fill();
  ctx.fillStyle = blackHole.color;
  ctx.beginPath();
  ctx.arc(bhX,bhY,blackHole.radius,0,Math.PI*2);
  ctx.fill();

  // Black hole particles
  for(let p of blackHole.particles){
    p.angle += p.speed;
    const px = bhX + Math.cos(p.angle)*p.r;
    const py = bhY + Math.sin(p.angle)*p.r;
    ctx.fillStyle = `rgba(200,50,250,0.3)`;
    ctx.beginPath();
    ctx.arc(px,py,p.size,0,Math.PI*2);
    ctx.fill();
  }
}

// --- Mini-map ---
function drawMiniMap(){
  const mapX=canvas.width-miniMap.width-miniMap.padding;
  const mapY=miniMap.padding;
  ctx.fillStyle="rgba(0,0,0,0.5)";
  ctx.fillRect(mapX,mapY,miniMap.width,miniMap.height);
  ctx.strokeStyle="white";
  ctx.strokeRect(mapX,mapY,miniMap.width,miniMap.height);

  let maxDist=0;
  for(let p of planets.concat([blackHole])){
    const d=Math.sqrt((p.x-player.x)**2+(p.y-player.y)**2)+p.radius;
    if(d>maxDist) maxDist=d;
  }
  if(maxDist<200) maxDist=200;
  const scale=(miniMap.width/2)/maxDist;

  for(let p of planets){
    const dx=p.x-player.x, dy=p.y-player.y;
    const px=mapX+miniMap.width/2+dx*scale;
    const py=mapY+miniMap.height/2+dy*scale;
    const r=Math.max(2,p.radius*scale);
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(px,py,r,0,Math.PI*2);
    ctx.fill();
  }
  // Black hole
  const dx=blackHole.x-player.x, dy=blackHole.y-player.y;
  const px=mapX+miniMap.width/2+dx*scale, py=mapY+miniMap.height/2+dy*scale;
  const r=Math.max(2,blackHole.radius*scale);
  ctx.fillStyle="rgba(180,180,180,0.3)";
  ctx.beginPath();
  ctx.arc(px,py,r,0,Math.PI*2);
  ctx.fill();

  // Player
  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(mapX+miniMap.width/2,mapY+miniMap.height/2,4,0,Math.PI*2);
  ctx.fill();
}

// --- Game Loop ---
function loop(){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  drawStars();
  updatePlayer();
  drawPlanets();

  // Draw all players
  for(let id in playersData){
    const pl=playersData[id];
    drawPlayer(pl);
  }
  drawPlayer(player);
  drawMiniMap();
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
