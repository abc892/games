<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gravity Ball Multiplayer</title>
<style>
  body { margin:0; background:black; overflow:hidden; }
  canvas { display:block; }
  #overlay {
    position:fixed;
    inset:0;
    background:black;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10;
  }
  #overlay input {
    font-size:20px;
    padding:10px;
  }
</style>
</head>
<body>

<div id="overlay">
  <input id="nameInput" placeholder="Enter your name" />
</div>

<canvas id="game"></canvas>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAwEy-sJx7E61BA6VmBfIFMZsjuAj8RK5g",
  authDomain: "games-c3e27.firebaseapp.com",
  databaseURL: "https://games-c3e27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "games-c3e27",
  storageBucket: "games-c3e27.firebasestorage.app",
  messagingSenderId: "193027632069",
  appId: "1:193027632069:web:b559c3b10011bc6982b9ac"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

/* ================= CONSTANTS ================= */
const G = 0.15;
const thrust = 0.1;
const keys = {};
const playerRadius = 8;

/* ================= STATE ================= */
let myId = null;
let myName = "";
let me = null;
let players = {};
let planets = [];
let blackHole = null;
let worldLoaded = false;

/* ================= INPUT ================= */
addEventListener("keydown", e => keys[e.key] = true);
addEventListener("keyup", e => keys[e.key] = false);

/* ================= JOIN ================= */
document.getElementById("nameInput").addEventListener("keydown", e => {
  if (e.key === "Enter" && e.target.value.trim()) {
    myName = e.target.value.trim();
    document.getElementById("overlay").remove();
    startGame();
  }
});

/* ================= START ================= */
function startGame() {
  const playerRef = db.ref("players").push();
  myId = playerRef.key;

  me = {
    id: myId,
    name: myName,
    x: 0, y: 0,
    vx: 0, vy: 0,
    angle: 0
  };

  playerRef.set(me);
  playerRef.onDisconnect().remove();

  loadWorld();
  listenPlayers();
  loop();
}

/* ================= WORLD ================= */
function loadWorld() {
  const worldRef = db.ref("world");

  worldRef.once("value", snap => {
    if (!snap.exists()) {
      // FIRST PLAYER CREATES WORLD
      planets = generatePlanets();
      blackHole = generateBlackHole();

      worldRef.set({ planets, blackHole });
      worldLoaded = true;
    }
  });

  worldRef.on("value", snap => {
    if (snap.exists()) {
      planets = snap.val().planets;
      blackHole = snap.val().blackHole;
      worldLoaded = true;
    }
  });
}

/* ================= PLAYERS ================= */
function listenPlayers() {
  db.ref("players").on("value", snap => {
    players = snap.val() || {};
  });
}

/* ================= PHYSICS ================= */
function applyGravity(p) {
  for (let b of [...planets, blackHole]) {
    let dx = b.x - p.x;
    let dy = b.y - p.y;
    let dist = Math.hypot(dx, dy) || 0.01;
    let accel = G * b.mass / (dist * dist);
    p.vx += accel * dx / dist;
    p.vy += accel * dy / dist;
  }
}

/* ================= PLAYER UPDATE ================= */
function updateMe() {
  if (!worldLoaded) return;

  if (keys["ArrowLeft"]) me.angle -= 0.05;
  if (keys["ArrowRight"]) me.angle += 0.05;
  if (keys["ArrowUp"]) {
    me.vx += Math.cos(me.angle) * thrust;
    me.vy += Math.sin(me.angle) * thrust;
  }

  applyGravity(me);

  me.x += me.vx;
  me.y += me.vy;

  db.ref("players/" + myId).update(me);
}

/* ================= COLLISION ================= */
function playerCollision() {
  for (let id in players) {
    if (id === myId) continue;
    let p = players[id];
    let dx = me.x - p.x;
    let dy = me.y - p.y;
    let dist = Math.hypot(dx, dy);
    if (dist < playerRadius * 2) {
      let nx = dx / dist;
      me.x = p.x + nx * playerRadius * 2;
      me.vx *= 0.9;
      me.vy *= 0.9;
    }
  }
}

/* ================= DRAW ================= */
function draw() {
  ctx.fillStyle = "black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const cx = canvas.width/2;
  const cy = canvas.height/2;

  // Planets
  for (let p of planets) {
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x-me.x+cx, p.y-me.y+cy, p.radius, 0, Math.PI*2);
    ctx.fill();
  }

  // Black hole
  ctx.fillStyle = "purple";
  ctx.beginPath();
  ctx.arc(blackHole.x-me.x+cx, blackHole.y-me.y+cy, blackHole.radius, 0, Math.PI*2);
  ctx.fill();

  // Players
  for (let id in players) {
    let p = players[id];
    let sx = p.x - me.x + cx;
    let sy = p.y - me.y + cy;

    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(sx, sy, playerRadius, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "cyan";
    ctx.font = "12px Arial";
    ctx.textAlign = "center";
    ctx.fillText(p.name, sx, sy - 12);
  }
}

/* ================= LOOP ================= */
function loop() {
  updateMe();
  playerCollision();
  draw();
  requestAnimationFrame(loop);
}

/* ================= GENERATORS ================= */
function generatePlanets() {
  const colors = ["red","blue","green","orange","purple","yellow"];
  let arr = [];
  while (arr.length < 10) {
    let r = 30 + Math.random()*80;
    let x = Math.random()*3000-1500;
    let y = Math.random()*3000-1500;
    arr.push({
      x, y,
      radius: r,
      mass: r*r*r*0.1,
      color: colors[Math.floor(Math.random()*colors.length)]
    });
  }
  return arr;
}

function generateBlackHole() {
  return {
    x: 5000,
    y: 5000,
    radius: 120,
    mass: 100000
  };
}
</script>
</body>
</html>
