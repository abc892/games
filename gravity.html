<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gravity Multiplayer</title>
<style>
body { margin:0; background:black; overflow:hidden; }
canvas { display:block; }
#overlay {
  position:fixed; inset:0;
  background:black;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}
#overlay input {
  font-size:20px;
  padding:10px;
}
</style>
</head>
<body>

<div id="overlay">
  <input id="nameInput" placeholder="Enter name and press Enter">
</div>

<canvas id="game"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAwEy-sJx7E61BA6VmBfIFMZsjuAj8RK5g",
  authDomain: "games-c3e27.firebaseapp.com",
  databaseURL: "https://games-c3e27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "games-c3e27",
  storageBucket: "games-c3e27.firebasestorage.app",
  messagingSenderId: "193027632069",
  appId: "1:193027632069:web:b559c3b10011bc6982b9ac"
});
const db = firebase.database();

/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

/* ================= CONSTANTS ================= */
const G = 0.15;
const thrust = 0.1;
const R = 8;

/* ================= STATE ================= */
let myId, me;
let players = {};
let planets = [];
let blackHole = null;
let ready = false;
const keys = {};

/* ================= INPUT ================= */
addEventListener("keydown", e => keys[e.key]=true);
addEventListener("keyup", e => keys[e.key]=false);

/* ================= JOIN ================= */
nameInput.onkeydown = e => {
  if (e.key === "Enter" && nameInput.value.trim()) {
    document.getElementById("overlay").remove();
    joinGame(nameInput.value.trim());
  }
};

/* ================= JOIN GAME ================= */
function joinGame(name){
  const ref = db.ref("players").push();
  myId = ref.key;

  me = {
    id: myId,
    name,
    x: Math.random()*100 - 50,
    y: Math.random()*100 - 50,
    vx: 0, vy: 0, angle: 0
  };

  ref.set(me);
  ref.onDisconnect().remove();

  db.ref("players").on("value", s => players = s.val() || {});
  loadWorld();
}

/* ================= WORLD ================= */
function loadWorld(){
  const w = db.ref("world");

  w.once("value", snap => {
    if (!snap.exists()) {
      planets = makePlanets();
      blackHole = makeBlackHole();
      w.set({ planets, blackHole });
    }
  });

  w.on("value", snap => {
    if (!snap.exists()) return;
    planets = snap.val().planets;
    blackHole = snap.val().blackHole;
    if (!ready) {
      ready = true;
      requestAnimationFrame(loop);
    }
  });
}

/* ================= PHYSICS ================= */
function gravity(p){
  for (let b of [...planets, blackHole]) {
    let dx = b.x - p.x;
    let dy = b.y - p.y;
    let d = Math.hypot(dx,dy) || 1;
    let a = G * b.mass / (d*d);
    p.vx += a * dx/d;
    p.vy += a * dy/d;
  }
}

/* ================= UPDATE ================= */
function update(){
  if (!ready) return;

  if (keys.ArrowLeft) me.angle -= 0.05;
  if (keys.ArrowRight) me.angle += 0.05;
  if (keys.ArrowUp) {
    me.vx += Math.cos(me.angle)*thrust;
    me.vy += Math.sin(me.angle)*thrust;
  }

  gravity(me);
  me.x += me.vx;
  me.y += me.vy;

  db.ref("players/"+myId).update(me);
}

/* ================= DRAW ================= */
function draw(){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const cx=canvas.width/2, cy=canvas.height/2;

  // stars
  for(let i=0;i<300;i++){
    ctx.fillStyle="white";
    ctx.fillRect(Math.random()*canvas.width,Math.random()*canvas.height,1,1);
  }

  // planets
  for(let p of planets){
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(p.x-me.x+cx,p.y-me.y+cy,p.radius,0,Math.PI*2);
    ctx.fill();
  }

  // black hole
  ctx.fillStyle="purple";
  ctx.beginPath();
  ctx.arc(blackHole.x-me.x+cx,blackHole.y-me.y+cy,blackHole.radius,0,Math.PI*2);
  ctx.fill();

  // players
  for(let id in players){
    let p=players[id];
    let sx=p.x-me.x+cx, sy=p.y-me.y+cy;
    ctx.fillStyle="white";
    ctx.beginPath();
    ctx.arc(sx,sy,R,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="cyan";
    ctx.textAlign="center";
    ctx.fillText(p.name,sx,sy-12);
  }
}

/* ================= LOOP ================= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

/* ================= GENERATORS ================= */
function makePlanets(){
  const c=["red","blue","green","orange","yellow"];
  let a=[];
  for(let i=0;i<10;i++){
    let r=30+Math.random()*80;
    a.push({
      x:Math.random()*2000-1000,
      y:Math.random()*2000-1000,
      radius:r,
      mass:r*r*r*0.1,
      color:c[i%5]
    });
  }
  return a;
}

function makeBlackHole(){
  return { x:3000,y:3000,radius:120,mass:100000 };
}
</script>
</body>
</html>
