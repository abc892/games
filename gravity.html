<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gravity Ball Multiplayer</title>
<style>
  body { margin:0; background:black; overflow:hidden; }
  canvas { display:block; }

  #nameOverlay{
    position:fixed; inset:0;
    background:black;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10;
  }
  #nameInput{
    font-size:22px;
    padding:12px 18px;
    border-radius:10px;
    border:none;
    outline:none;
  }
</style>
</head>
<body>

<div id="nameOverlay">
  <input id="nameInput" placeholder="Enter your name & press Enter">
</div>

<canvas id="game"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
// ---------------- FIREBASE ----------------
firebase.initializeApp({
  apiKey: "AIzaSyAwEy-sJx7E61BA6VmBfIFMZsjuAj8RK5g",
  authDomain: "games-c3e27.firebaseapp.com",
  databaseURL: "https://games-c3e27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "games-c3e27",
  storageBucket: "games-c3e27.firebasestorage.app",
  messagingSenderId: "193027632069",
  appId: "1:193027632069:web:b559c3b10011bc6982b9ac"
});
const db = firebase.database();

// ---------------- CANVAS ----------------
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

// ---------------- CONSTANTS ----------------
const G = 0.15;
const thrust = 0.12;
const keys = {};
const starSectorSize = 400;
const miniMap = { width:200, height:150, padding:10 };

// ---------------- PLAYER ----------------
const playerId = "p_" + Math.random().toString(36).slice(2);
let playerName = "";
const player = { x:0,y:0,vx:0,vy:0,angle:0,radius:8 };

// ---------------- WORLD ----------------
let planets = [];
let blackHole = null;
let players = {};

// ---------------- NAME INPUT ----------------
const overlay = document.getElementById("nameOverlay");
const nameInput = document.getElementById("nameInput");
nameInput.focus();

nameInput.onkeydown = e=>{
  if(e.key==="Enter" && nameInput.value.trim()){
    playerName = nameInput.value.trim();
    overlay.remove();
    init();
  }
};

// ---------------- RANDOM ----------------
function mulberry32(a){
  return function(){
    a|=0;a=a+0x6D2B79F5|0;
    let t=Math.imul(a^a>>>15,1|a);
    t=t+Math.imul(t^t>>>7,61|t)^t;
    return ((t^t>>>14)>>>0)/4294967296;
  }
}

// ---------------- WORLD GEN ----------------
function generateWorld(){
  const colors=["orange","red","green","blue","purple","yellow","pink","cyan","lime"];
  planets=[];
  while(planets.length<10){
    const r=30+Math.random()*90;
    const x=Math.random()*3000-1500;
    const y=Math.random()*3000-1500;
    if(Math.hypot(x,y)<200) continue;
    let ok=true;
    for(let p of planets){
      if(Math.hypot(x-p.x,y-p.y)<r+p.radius+50){ok=false;break;}
    }
    if(ok) planets.push({x,y,radius:r,mass:r*r*r*0.07,color:colors[Math.random()*colors.length|0]});
  }

  blackHole={x:5000,y:5000,radius:100,mass:800000,angle:0,particles:[]};
  for(let i=0;i<120;i++){
    blackHole.particles.push({
      r:blackHole.radius+Math.random()*180,
      angle:Math.random()*Math.PI*2,
      speed:0.002+Math.random()*0.004,
      size:1+Math.random()*2
    });
  }
  db.ref("gravity/world").set({planets,blackHole});
}

// ---------------- INIT ----------------
function init(){
  const worldRef=db.ref("gravity/world");
  const playersRef=db.ref("gravity/players");

  worldRef.once("value",snap=>{
    if(!snap.exists()) generateWorld();
    else{
      planets=snap.val().planets;
      blackHole=snap.val().blackHole;
    }
  });

  const myRef=playersRef.child(playerId);
  myRef.set({x:0,y:0,vx:0,vy:0,angle:0,name:playerName});
  myRef.onDisconnect().remove();

  playersRef.on("value",snap=>{
    players=snap.val()||{};
    if(Object.keys(players).length===0){
      db.ref("gravity/world").remove();
    }
  });

  window.addEventListener("keydown",e=>keys[e.key]=true);
  window.addEventListener("keyup",e=>keys[e.key]=false);

  lastTime=performance.now();
  requestAnimationFrame(loop);
}

// ---------------- PHYSICS ----------------
function applyGravity(dt){
  for(let p of planets.concat([blackHole])){
    let dx=p.x-player.x,dy=p.y-player.y;
    let d=Math.hypot(dx,dy)||0.1;
    let R=p.radius+player.radius;
    let a=d>R?G*p.mass/(d*d):G*p.mass*d/(R*R*R);
    player.vx+=a*(dx/d)*dt;
    player.vy+=a*(dy/d)*dt;
  }

  for(let id in players){
    if(id===playerId) continue;
    const o=players[id];
    let dx=o.x-player.x,dy=o.y-player.y;
    let d=Math.hypot(dx,dy);
    let min=player.radius*2;
    if(d<min&&d>0){
      let nx=dx/d,ny=dy/d;
      player.x-=nx*(min-d)/2;
      player.y-=ny*(min-d)/2;
    }
  }
}

// ---------------- UPDATE ----------------
function update(dt){
  if(keys.ArrowLeft) player.angle-=0.05*dt*60;
  if(keys.ArrowRight) player.angle+=0.05*dt*60;
  if(keys.ArrowUp){
    player.vx+=Math.cos(player.angle)*thrust*dt*60;
    player.vy+=Math.sin(player.angle)*thrust*dt*60;
  }
  applyGravity(dt);
  player.x+=player.vx*dt*60;
  player.y+=player.vy*dt*60;

  db.ref("gravity/players/"+playerId).update({
    x:player.x,y:player.y,vx:player.vx,vy:player.vy,angle:player.angle
  });
}

// ---------------- DRAW ----------------
function drawStars(){
  const cx=canvas.width/2,cy=canvas.height/2;
  const sx=Math.floor((player.x-cx)/starSectorSize)*starSectorSize;
  const sy=Math.floor((player.y-cy)/starSectorSize)*starSectorSize;
  for(let x=sx;x<sx+canvas.width+starSectorSize;x+=starSectorSize){
    for(let y=sy;y<sy+canvas.height+starSectorSize;y+=starSectorSize){
      const r=mulberry32(x*73856093^y*19349663);
      for(let i=0;i<12;i++){
        let px=x+r()*starSectorSize-player.x+cx;
        let py=y+r()*starSectorSize-player.y+cy;
        ctx.fillStyle="rgba(255,255,255,0.5)";
        ctx.fillRect(px,py,1,1);
      }
    }
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawStars();

  const cx=canvas.width/2,cy=canvas.height/2;

  for(let p of planets){
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(p.x-player.x+cx,p.y-player.y+cy,p.radius,0,Math.PI*2);
    ctx.fill();
  }

  let bx=blackHole.x-player.x+cx,by=blackHole.y-player.y+cy;
  blackHole.angle+=0.01;
  for(let pt of blackHole.particles){
    pt.angle+=pt.speed;
    ctx.fillStyle="rgba(200,50,250,0.4)";
    ctx.beginPath();
    ctx.arc(bx+Math.cos(pt.angle)*pt.r,by+Math.sin(pt.angle)*pt.r,pt.size,0,Math.PI*2);
    ctx.fill();
  }
  ctx.fillStyle="black";
  ctx.beginPath();
  ctx.arc(bx,by,blackHole.radius,0,Math.PI*2);
  ctx.fill();

  for(let id in players){
    const p=players[id];
    const px=p.x-player.x+cx,py=p.y-player.y+cy;
    ctx.fillStyle="white";
    ctx.beginPath();
    ctx.arc(px,py,player.radius,0,Math.PI*2);
    ctx.fill();
    ctx.fillText(p.name,px,py-14);
  }
}

// ---------------- LOOP ----------------
let lastTime=0;
function loop(t){
  let dt=Math.min((t-lastTime)/1000,0.05);
  lastTime=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
