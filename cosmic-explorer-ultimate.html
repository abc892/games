<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Master - Ultimate Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Courier New', monospace;
        }
        
        #gameCanvas {
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #0f3460;
            border: 4px solid #00ff88;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 200;
            overflow-y: auto;
        }
        
        .screen.active {
            display: flex;
        }
        
        .menu-container {
            background: rgba(15, 52, 96, 0.95);
            border: 3px solid #00ff88;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.6);
            margin: 20px;
        }
        
        .menu-title {
            color: #00ff88;
            font-size: 42px;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #00ff88;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px #00ff88; }
            50% { text-shadow: 0 0 40px #00ff88, 0 0 60px #00ff88; }
        }
        
        .menu-btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: linear-gradient(135deg, #00ff88, #00d4aa);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }
        
        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.8);
        }
        
        .menu-btn.danger {
            background: linear-gradient(135deg, #ff4757, #ff6348);
        }
        
        .menu-btn.secondary {
            background: linear-gradient(135deg, #5f27cd, #341f97);
        }
        
        .menu-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            border-radius: 10px;
            color: #00ff88;
            font-size: 18px;
            font-family: 'Courier New', monospace;
        }
        
        input[type="text"]::placeholder {
            color: rgba(0, 255, 136, 0.5);
        }
        
        #hud {
            position: absolute;
            top: 30px;
            left: 30px;
            color: #00ff88;
            font-size: 24px;
            text-shadow: 0 0 15px #00ff88;
            z-index: 100;
            pointer-events: none;
        }
        
        #timer {
            position: absolute;
            top: 30px;
            right: 30px;
            color: #ffd93d;
            font-size: 32px;
            text-shadow: 0 0 20px #ffd93d;
            z-index: 100;
            pointer-events: none;
            font-weight: bold;
        }
        
        #pauseBtn {
            position: absolute;
            top: 100px;
            right: 30px;
            padding: 12px 30px;
            background: rgba(0, 255, 136, 0.3);
            border: 3px solid #00ff88;
            border-radius: 8px;
            color: #00ff88;
            font-size: 18px;
            cursor: pointer;
            z-index: 100;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        #pauseBtn:hover {
            background: rgba(0, 255, 136, 0.5);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
        }
        
        .leaderboard-list, .player-list, .skin-grid {
            max-height: 450px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .leaderboard-entry, .player-entry {
            display: flex;
            justify-content: space-between;
            padding: 18px;
            margin: 8px 0;
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            border-radius: 8px;
            color: #00ff88;
            font-size: 16px;
        }
        
        .leaderboard-entry.current-user {
            background: rgba(255, 215, 61, 0.2);
            border-color: #ffd93d;
            color: #ffd93d;
        }
        
        .player-entry.ready {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
        }
        
        .rank {
            font-weight: bold;
            margin-right: 15px;
            font-size: 20px;
        }
        
        .stats-container {
            margin: 20px 0;
            padding: 25px;
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            border-radius: 12px;
            color: #00ff88;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            font-size: 16px;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            color: #00ff88;
            font-size: 18px;
            margin: 20px 0;
        }
        
        .subtitle {
            text-align: center;
            color: #00d4aa;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .lobby-code {
            text-align: center;
            font-size: 36px;
            color: #ffd93d;
            background: rgba(255, 217, 61, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #ffd93d;
            letter-spacing: 8px;
        }
        
        .coin-display {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffd93d;
            font-size: 28px;
            text-shadow: 0 0 20px #ffd93d;
            z-index: 100;
            pointer-events: none;
            font-weight: bold;
        }
        
        /* Prize Belt */
        .prize-belt-container {
            position: relative;
            height: 150px;
            overflow: hidden;
            margin: 20px 0;
            border: 3px solid #00ff88;
            border-radius: 10px;
        }
        
        .prize-belt {
            display: flex;
            position: absolute;
            transition: none;
        }
        
        .prize-belt.spinning {
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .prize-item {
            min-width: 120px;
            height: 120px;
            margin: 15px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            border: 3px solid;
        }
        
        .prize-item.rare {
            background: rgba(100, 149, 237, 0.3);
            border-color: #6495ed;
        }
        
        .prize-item.epic {
            background: rgba(138, 43, 226, 0.3);
            border-color: #8a2be2;
        }
        
        .prize-item.legendary {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .prize-selector {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ff4757;
            transform: translateX(-50%);
            box-shadow: 0 0 20px #ff4757;
            z-index: 10;
        }
        
        .spin-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #ffd93d, #f39c12);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        
        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Skin Reveal Overlay */
        .skin-reveal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }
        
        .skin-reveal-overlay.active {
            display: flex;
        }
        
        .skin-reveal-card {
            background: rgba(15, 52, 96, 0.95);
            border: 3px solid #00ff88;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            animation: popIn 0.5s ease-out;
        }
        
        @keyframes popIn {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .skin-reveal-card.rare {
            border-color: #6495ed;
            box-shadow: 0 0 40px rgba(100, 149, 237, 0.6);
        }
        
        .skin-reveal-card.epic {
            border-color: #8a2be2;
            box-shadow: 0 0 40px rgba(138, 43, 226, 0.6);
        }
        
        .skin-reveal-card.legendary {
            border-color: #ffd700;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.8);
            animation: popIn 0.5s ease-out, legendaryGlow 2s infinite;
        }
        
        @keyframes legendaryGlow {
            0%, 100% { box-shadow: 0 0 60px rgba(255, 215, 0, 0.8); }
            50% { box-shadow: 0 0 80px rgba(255, 215, 0, 1); }
        }
        
        .skin-reveal-emoji {
            font-size: 150px;
            margin: 20px 0;
        }
        
        .skin-reveal-name {
            font-size: 36px;
            color: #00ff88;
            margin: 20px 0;
        }
        
        .skin-reveal-rarity {
            font-size: 24px;
            margin: 10px 0;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .skin-reveal-rarity.rare {
            color: #6495ed;
        }
        
        .skin-reveal-rarity.epic {
            color: #8a2be2;
        }
        
        .skin-reveal-rarity.legendary {
            color: #ffd700;
        }
        
        .skin-reveal-btns {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .skin-reveal-btns button {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        .skin-reveal-btns .equip-btn {
            background: linear-gradient(135deg, #00ff88, #00d4aa);
            color: #000;
        }
        
        .skin-reveal-btns .cancel-btn {
            background: linear-gradient(135deg, #555, #333);
            color: #fff;
        }
        
        /* Skin Grid */
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            padding: 20px;
            max-height: 400px;
        }
        
        .skin-card {
            background: rgba(0, 255, 136, 0.1);
            border: 3px solid #00ff88;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .skin-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .skin-card.equipped {
            border-color: #ffd93d;
            background: rgba(255, 217, 61, 0.2);
        }
        
        .skin-card.rare {
            border-color: #6495ed;
        }
        
        .skin-card.epic {
            border-color: #8a2be2;
        }
        
        .skin-card.legendary {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .skin-icon {
            font-size: 50px;
            margin: 10px 0;
        }
        
        .skin-name {
            font-size: 12px;
            color: #00ff88;
            margin: 5px 0;
        }
        
        .skin-count {
            font-size: 10px;
            color: #00d4aa;
        }
        
        .extra-life-indicator {
            position: absolute;
            top: 150px;
            right: 30px;
            color: #ffd700;
            font-size: 24px;
            text-shadow: 0 0 20px #ffd700;
            z-index: 100;
            pointer-events: none;
            font-weight: bold;
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            25% { opacity: 0.3; }
            50% { opacity: 0.7; }
            75% { opacity: 0.4; }
        }
        
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen active">
        <div class="menu-container">
            <div class="menu-title">üêç SNAKE MASTER</div>
            <div class="subtitle">Enter the Arena</div>
            <input type="text" id="nameInput" placeholder="Enter your name" maxlength="20">
            <button class="menu-btn" onclick="saveUserName()">START GAME</button>
        </div>
    </div>
    
    <!-- Home Screen -->
    <div id="homeScreen" class="screen">
        <div class="menu-container">
            <div class="menu-title">üêç SNAKE MASTER</div>
            <div class="subtitle">Welcome back, <span id="welcomeName"></span>!</div>
            <div style="text-align: center; color: #ffd93d; font-size: 24px; margin: 15px 0;">
                üí∞ Coins: <span id="homeCoins">0</span>
            </div>
            <button class="menu-btn" onclick="startGame()">PLAY SOLO</button>
            <button class="menu-btn secondary" onclick="showMultiplayer()">MULTIPLAYER</button>
            <button class="menu-btn" onclick="showShop()">üõí SHOP</button>
            <button class="menu-btn" onclick="showLocker()">üé® LOCKER</button>
            <button class="menu-btn" onclick="showLeaderboard()">LEADERBOARD</button>
            <button class="menu-btn" onclick="showSettings()">SETTINGS</button>
        </div>
    </div>
    
    <!-- Multiplayer Menu -->
    <div id="multiplayerScreen" class="screen">
        <div class="menu-container">
            <div class="menu-title">üéÆ MULTIPLAYER</div>
            <button class="menu-btn" onclick="createLobby()">CREATE LOBBY</button>
            <input type="text" id="joinCodeInput" placeholder="Enter 6-digit code" maxlength="6">
            <button class="menu-btn" onclick="joinLobby()">JOIN LOBBY</button>
            <button class="menu-btn danger" onclick="backToHome()">BACK</button>
        </div>
    </div>
    
    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="screen">
        <div class="menu-container">
            <div class="menu-title">üéÆ LOBBY</div>
            <div class="lobby-code" id="lobbyCode">------</div>
            <div class="subtitle">Share this code with friends!</div>
            <div class="player-list" id="playerList"></div>
            <button class="menu-btn" id="readyBtn" onclick="toggleReady()">READY</button>
            <button class="menu-btn danger" onclick="leaveLobby()">LEAVE LOBBY</button>
        </div>
    </div>
    
    <!-- Shop Screen -->
    <div id="shopScreen" class="screen">
        <div class="menu-container">
            <div class="menu-title">üõí SHOP</div>
            <div style="text-align: center; color: #ffd93d; font-size: 24px; margin: 15px 0;">
                üí∞ Your Coins: <span id="shopCoins">0</span>
            </div>
            <div class="subtitle">Prize Belt - 500 Coins per Spin</div>
            <div class="prize-belt-container">
                <div class="prize-selector"></div>
                <div class="prize-belt" id="prizeBelt"></div>
            </div>
            <button class="spin-btn" id="spinBtn" onclick="spinPrizeBelt()">üé∞ SPIN (500 COINS)</button>
            <button class="menu-btn" onclick="backToHome()">BACK</button>
        </div>
    </div>
    
    <!-- Skin Reveal Overlay -->
    <div class="skin-reveal-overlay" id="skinRevealOverlay">
        <div class="skin-reveal-card" id="skinRevealCard">
            <div class="skin-reveal-emoji" id="revealEmoji"></div>
            <div class="skin-reveal-name" id="revealName"></div>
            <div class="skin-reveal-rarity" id="revealRarity"></div>
            <div class="skin-reveal-btns">
                <button class="equip-btn" onclick="equipRevealedSkin()">EQUIP</button>
                <button class="cancel-btn" onclick="closeReveal()">CANCEL</button>
            </div>
        </div>
    </div>
    
    <!-- Locker Screen -->
    <div id="lockerScreen" class="screen">
        <div class="menu-container" style="max-width: 700px;">
            <div class="menu-title">üé® LOCKER</div>
            <div class="subtitle">Click to equip a skin</div>
            <div class="skin-grid" id="skinGrid"></div>
            <button class="menu-btn" onclick="backToHome()">BACK</button>
        </div>
    </div>
    
    <!-- Victory Screen -->
    <div id="victoryScreen" class="screen">
        <div class="menu-container">
            <div class="menu-title">üëë VICTORY!</div>
            <div style="color: #ffd93d; text-align: center; margin: 30px 0; font-size: 32px;">
                YOU ARE THE CHAMPION!
            </div>
            <div style="color: #00ff88; text-align: center; margin-bottom: 20px; font-size: 20px;">
                Final Score: <span id="victoryScore"></span><br>
                Final Length: <span id="victoryLength"></span>
            </div>
            <button class="menu-btn" onclick="backToHome()">HOME</button>
        </div>
    </div>
    
    <!-- Pause Screen -->
    <div id="pauseScreen" class="screen">
        <div class="menu-container">
            <div class="menu-title">‚è∏ PAUSED</div>
            <div style="color: #00ff88; text-align: center; margin-bottom: 20px; font-size: 20px;">
                Score: <span id="pauseScore"></span><br>
                Time: <span id="pauseTime"></span>s
            </div>
            <button class="menu-btn" onclick="resumeGame()">RESUME</button>
            <button class="menu-btn danger" onclick="leaveGame()">LEAVE</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="screen">
        <div class="menu-container">
            <div class="menu-title">üíÄ GAME OVER</div>
            <div style="color: #ff4757; text-align: center; margin: 20px 0; font-size: 28px;">
                Final Score: <span id="finalScore"></span>
            </div>
            <div style="color: #00ff88; text-align: center; margin-bottom: 20px; font-size: 18px;">
                Survival Time: <span id="finalTime"></span>s<br>
                Snake Length: <span id="finalLength"></span><br>
                Coins Earned: <span id="coinsEarned"></span>
            </div>
            <button class="menu-btn" onclick="playAgain()">PLAY AGAIN</button>
            <button class="menu-btn" onclick="backToHome()">HOME</button>
        </div>
    </div>
    
    <!-- Leaderboard Screen -->
    <div id="leaderboardScreen" class="screen">
        <div class="menu-container" style="max-width: 650px;">
            <div class="menu-title">üèÜ LEADERBOARD</div>
            <div class="subtitle">Top Players by Score</div>
            <div class="loading" id="leaderboardLoading">Loading...</div>
            <div class="leaderboard-list" id="leaderboardList"></div>
            <button class="menu-btn" onclick="backToHome()">BACK</button>
        </div>
    </div>
    
    <!-- Settings Screen -->
    <div id="settingsScreen" class="screen">
        <div class="menu-container">
            <div class="menu-title">‚öô SETTINGS</div>
            <div class="stats-container">
                <div class="stat-row">
                    <span>Player Name:</span>
                    <span id="settingsName"></span>
                </div>
                <div class="stat-row">
                    <span>üèÜ Highest Score:</span>
                    <span id="settingsHighScore">0</span>
                </div>
                <div class="stat-row">
                    <span>‚è± Longest Time:</span>
                    <span id="settingsBestTime">0s</span>
                </div>
                <div class="stat-row">
                    <span>üìä Average Score:</span>
                    <span id="settingsAvgScore">0</span>
                </div>
                <div class="stat-row">
                    <span>üí∞ Total Coins:</span>
                    <span id="settingsCoins">0</span>
                </div>
                <div class="stat-row">
                    <span>üéÆ Games Played:</span>
                    <span id="settingsGamesPlayed">0</span>
                </div>
            </div>
            <input type="text" id="newNameInput" placeholder="Change your name" maxlength="20">
            <div class="subtitle" id="nameChangeInfo"></div>
            <button class="menu-btn" onclick="changeName()">CHANGE NAME</button>
            <button class="menu-btn danger" onclick="deleteAccount()">DELETE ACCOUNT</button>
            <button class="menu-btn" onclick="backToHome()">BACK</button>
        </div>
    </div>
    
    <!-- Game HUD -->
    <div id="hud" style="display: none;">
        <div>SCORE: <span id="score">0</span></div>
        <div>LENGTH: <span id="length">1</span></div>
    </div>
    
    <div id="coinDisplay" class="coin-display" style="display: none;">üí∞ <span id="coins">0</span></div>
    <div id="extraLifeIndicator" class="extra-life-indicator" style="display: none;">‚ù§Ô∏è EXTRA LIFE</div>
    <div id="timer" style="display: none;">0s</div>
    <button id="pauseBtn" style="display: none;" onclick="pauseGame()">PAUSE</button>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, update, remove, onValue, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAwEy-sJx7E61BA6VmBfIFMZsjuAj8RK5g",
            authDomain: "games-c3e27.firebaseapp.com",
            databaseURL: "https://games-c3e27-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "games-c3e27",
            storageBucket: "games-c3e27.firebasestorage.app",
            messagingSenderId: "193027632069",
            appId: "1:193027632069:web:b559c3b10011bc6982b9ac"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Skin definitions with visual properties
        const SKINS = {
            default: { 
                name: 'Classic', emoji: 'üü¢', rarity: 'common', color: '#00ff88',
                pattern: 'solid', glow: false
            },
            rainbow: { 
                name: 'Rainbow', emoji: 'üåà', rarity: 'rare', color: '#ff6b6b',
                pattern: 'rainbow', glow: true
            },
            fire: { 
                name: 'Fire', emoji: 'üî•', rarity: 'rare', color: '#ff4757',
                pattern: 'gradient', glow: true, gradient: ['#ff4757', '#ff6348']
            },
            ice: { 
                name: 'Ice', emoji: '‚ùÑÔ∏è', rarity: 'rare', color: '#48dbfb',
                pattern: 'solid', glow: true
            },
            electric: { 
                name: 'Electric', emoji: '‚ö°', rarity: 'rare', color: '#ffd93d',
                pattern: 'solid', glow: true
            },
            toxic: { 
                name: 'Toxic', emoji: '‚ò¢Ô∏è', rarity: 'rare', color: '#a3cb38',
                pattern: 'solid', glow: true
            },
            crystal: { 
                name: 'Crystal', emoji: 'üíé', rarity: 'rare', color: '#4bcffa',
                pattern: 'gradient', glow: true, gradient: ['#4bcffa', '#00d2d3']
            },
            galaxy: { 
                name: 'Galaxy', emoji: 'üåå', rarity: 'rare', color: '#5f27cd',
                pattern: 'stars', glow: true
            },
            dragon: { 
                name: 'Dragon', emoji: 'üêâ', rarity: 'epic', color: '#ff6348',
                pattern: 'scales', glow: true
            },
            crown: { 
                name: 'Crown', emoji: 'üëë', rarity: 'epic', color: '#ffd700',
                pattern: 'gradient', glow: true, gradient: ['#ffd700', '#ffed4e']
            },
            legendary: { 
                name: 'Legendary', emoji: '‚ú®', rarity: 'legendary', color: '#ffd700',
                pattern: 'rainbow', glow: true, extraLife: true
            }
        };
        
        const PLAYER_COLORS = [
            '#00ff88', '#ff4757', '#ffd93d', '#5f27cd', 
            '#00d2d3', '#ff6348', '#48dbfb', '#ff9ff3',
            '#54a0ff', '#00d2d3'
        ];
        
        // Game State
        let gameState = {
            score: 0,
            coins: 0,
            foodEaten: 0,
            isPlaying: false,
            isPaused: false,
            isMultiplayer: false,
            startTime: 0,
            userId: null,
            userName: null,
            snake: [],
            food: null,
            direction: null,
            nextDirection: null,
            currentLobby: null,
            playerColor: null,
            equippedSkin: 'default',
            alivePlayers: 0,
            hasExtraLife: false,
            usedExtraLife: false,
            isReviving: false,
            reviveFlickerCount: 0
        };
        
        let otherPlayers = {};
        let lobbyListener = null;
        let wonSkinId = null;
        let savedSnakeLength = 0;
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        let tileCount = 30;
        let gameInterval = null;
        let rainbowHue = 0;
        
        function setCanvasSize(multiplayer = false) {
            tileCount = multiplayer ? 60 : 30;
            canvas.width = gridSize * tileCount;
            canvas.height = gridSize * tileCount;
        }
        
        function generateUserId() {
            return 'snake_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function generateLobbyCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        function checkExistingUser() {
            const userId = localStorage.getItem('snakeMasterUserId');
            if (userId) {
                gameState.userId = userId;
                get(ref(database, 'snakeUsers/' + userId)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        gameState.userName = userData.name;
                        gameState.coins = userData.coins || 0;
                        gameState.equippedSkin = userData.equippedSkin || 'default';
                        showScreen('homeScreen');
                        document.getElementById('welcomeName').textContent = userData.name;
                        document.getElementById('homeCoins').textContent = gameState.coins;
                    } else {
                        localStorage.removeItem('snakeMasterUserId');
                        showScreen('welcomeScreen');
                    }
                }).catch(() => showScreen('welcomeScreen'));
            } else {
                showScreen('welcomeScreen');
            }
        }
        
        window.saveUserName = function() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) { alert('Please enter a name!'); return; }
            
            const userId = generateUserId();
            gameState.userId = userId;
            gameState.userName = name;
            
            const userData = {
                name, highScore: 0, bestTime: 0, totalScore: 0,
                gamesPlayed: 0, coins: 0, equippedSkin: 'default',
                skins: { default: 1 }, createdAt: Date.now(), lastNameChange: Date.now()
            };
            
            set(ref(database, 'snakeUsers/' + userId), userData).then(() => {
                localStorage.setItem('snakeMasterUserId', userId);
                document.getElementById('welcomeName').textContent = name;
                document.getElementById('homeCoins').textContent = 0;
                showScreen('homeScreen');
            }).catch(err => alert('Database error: ' + err.message));
        };
        
        window.changeName = function() {
            const newName = document.getElementById('newNameInput').value.trim();
            if (!newName) { alert('Please enter a new name!'); return; }
            
            get(ref(database, 'snakeUsers/' + gameState.userId)).then((snapshot) => {
                const userData = snapshot.val();
                const daysSince = (Date.now() - (userData.lastNameChange || 0)) / (1000 * 60 * 60 * 24);
                
                if (daysSince < 10) {
                    alert(`You can change your name in ${Math.ceil(10 - daysSince)} days!`);
                    return;
                }
                
                update(ref(database, 'snakeUsers/' + gameState.userId), {
                    name: newName, lastNameChange: Date.now()
                }).then(() => {
                    gameState.userName = newName;
                    document.getElementById('welcomeName').textContent = newName;
                    document.getElementById('settingsName').textContent = newName;
                    document.getElementById('newNameInput').value = '';
                    alert('Name changed!');
                    loadSettings();
                });
            });
        };
        
        window.deleteAccount = function() {
            if (confirm('Delete account? Cannot be undone!')) {
                remove(ref(database, 'snakeUsers/' + gameState.userId)).then(() => {
                    localStorage.removeItem('snakeMasterUserId');
                    location.reload();
                });
            }
        };
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (screenId) {
                const screen = document.getElementById(screenId);
                if (screen) screen.classList.add('active');
            }
            
            if (screenId === 'homeScreen') {
                document.getElementById('hud').style.display = 'none';
                document.getElementById('timer').style.display = 'none';
                document.getElementById('coinDisplay').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('extraLifeIndicator').style.display = 'none';
            }
        }
        
        window.startGame = function() {
            gameState.isMultiplayer = false;
            setCanvasSize(false);
            gameState.playerColor = SKINS[gameState.equippedSkin].color;
            gameState.hasExtraLife = SKINS[gameState.equippedSkin].extraLife || false;
            gameState.usedExtraLife = false;
            gameState.isReviving = false;
            gameState.reviveFlickerCount = 0;
            startGameCommon();
        };
        
        function startGameCommon() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('hud').style.display = 'block';
            document.getElementById('timer').style.display = 'block';
            document.getElementById('coinDisplay').style.display = 'block';
            if (!gameState.isMultiplayer) document.getElementById('pauseBtn').style.display = 'block';
            
            if (gameState.hasExtraLife && !gameState.usedExtraLife) {
                document.getElementById('extraLifeIndicator').style.display = 'block';
            }
            
            initGame();
            gameState.isPlaying = true;
            gameState.isPaused = false;
            gameState.startTime = Date.now();
            gameState.score = 0;
            gameState.foodEaten = 0;
            
            document.getElementById('coins').textContent = gameState.coins;
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, 100);
        }
        
        window.pauseGame = function() {
            if (!gameState.isPlaying || gameState.isPaused || gameState.isMultiplayer) return;
            
            gameState.isPaused = true;
            clearInterval(gameInterval);
            const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
            document.getElementById('pauseScore').textContent = gameState.score;
            document.getElementById('pauseTime').textContent = elapsed;
            showScreen('pauseScreen');
        };
        
        window.resumeGame = function() {
            gameState.isPaused = false;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('hud').style.display = 'block';
            document.getElementById('timer').style.display = 'block';
            document.getElementById('coinDisplay').style.display = 'block';
            document.getElementById('pauseBtn').style.display = 'block';
            if (gameState.hasExtraLife && !gameState.usedExtraLife) {
                document.getElementById('extraLifeIndicator').style.display = 'block';
            }
            gameInterval = setInterval(gameLoop, 100);
        };
        
        window.leaveGame = function() {
            gameState.isPlaying = false;
            if (gameInterval) clearInterval(gameInterval);
            
            if (gameState.isMultiplayer && gameState.currentLobby) {
                remove(ref(database, `lobbies/${gameState.currentLobby}/players/${gameState.userId}`));
                if (lobbyListener) lobbyListener();
                gameState.currentLobby = null;
            }
            showScreen('homeScreen');
        };
        
        window.playAgain = function() { startGame(); };
        window.backToHome = function() {
            if (gameState.currentLobby && lobbyListener) {
                remove(ref(database, `lobbies/${gameState.currentLobby}/players/${gameState.userId}`));
                lobbyListener();
                gameState.currentLobby = null;
            }
            showScreen('homeScreen');
        };
        window.showMultiplayer = function() { showScreen('multiplayerScreen'); };
        
        window.createLobby = function() {
            const lobbyCode = generateLobbyCode();
            gameState.currentLobby = lobbyCode;
            gameState.playerColor = PLAYER_COLORS[0];
            
            set(ref(database, `lobbies/${lobbyCode}`), {
                code: lobbyCode, host: gameState.userId, createdAt: Date.now(),
                gameStarted: false, players: {
                    [gameState.userId]: {
                        name: gameState.userName, ready: false,
                        color: gameState.playerColor, skin: gameState.equippedSkin, alive: false
                    }
                }
            }).then(() => {
                onDisconnect(ref(database, `lobbies/${lobbyCode}/players/${gameState.userId}`)).remove();
                showLobbyScreen(lobbyCode);
            });
        };
        
        window.joinLobby = function() {
            const code = document.getElementById('joinCodeInput').value.trim();
            if (code.length !== 6) { alert('Enter 6-digit code!'); return; }
            
            get(ref(database, `lobbies/${code}`)).then((snapshot) => {
                if (!snapshot.exists()) { alert('Lobby not found!'); return; }
                
                const lobby = snapshot.val();
                const playerCount = Object.keys(lobby.players || {}).length;
                
                if (playerCount >= 10) { alert('Lobby full!'); return; }
                
                gameState.currentLobby = code;
                gameState.playerColor = PLAYER_COLORS[playerCount];
                
                update(ref(database, `lobbies/${code}/players/${gameState.userId}`), {
                    name: gameState.userName, ready: false,
                    color: gameState.playerColor, skin: gameState.equippedSkin, alive: false
                }).then(() => {
                    onDisconnect(ref(database, `lobbies/${code}/players/${gameState.userId}`)).remove();
                    showLobbyScreen(code);
                });
            });
        };
        
        function showLobbyScreen(code) {
            document.getElementById('lobbyCode').textContent = code;
            document.getElementById('readyBtn').disabled = false;
            document.getElementById('readyBtn').textContent = 'READY';
            showScreen('lobbyScreen');
            
            lobbyListener = onValue(ref(database, `lobbies/${code}`), (snapshot) => {
                if (!snapshot.exists()) { alert('Lobby closed!'); showScreen('homeScreen'); return; }
                
                const lobby = snapshot.val();
                updatePlayerList(lobby.players);
                
                if (lobby.gameStarted && !lobby.players[gameState.userId].alive) {
                    document.getElementById('readyBtn').textContent = 'GAME IN PROGRESS';
                    document.getElementById('readyBtn').disabled = true;
                } else if (lobby.gameStarted && lobby.players[gameState.userId].alive) {
                    gameState.isMultiplayer = true;
                    gameState.hasExtraLife = SKINS[gameState.equippedSkin].extraLife || false;
                    gameState.usedExtraLife = false;
                    gameState.isReviving = false;
                    gameState.reviveFlickerCount = 0;
                    setCanvasSize(true);
                    startMultiplayerGame(lobby);
                }
            });
        }
        
        function updatePlayerList(players) {
            const list = document.getElementById('playerList');
            list.innerHTML = '';
            
            Object.entries(players).forEach(([id, player]) => {
                const entry = document.createElement('div');
                entry.className = 'player-entry' + (player.ready ? ' ready' : '');
                entry.innerHTML = `
                    <span style="color: ${player.color}">‚¨§ ${player.name}</span>
                    <span>${player.ready ? '‚úì READY' : '‚úó NOT READY'}</span>
                `;
                list.appendChild(entry);
            });
        }
        
        window.toggleReady = function() {
            get(ref(database, `lobbies/${gameState.currentLobby}/players/${gameState.userId}`)).then((snapshot) => {
                const currentReady = snapshot.val().ready;
                update(ref(database, `lobbies/${gameState.currentLobby}/players/${gameState.userId}`), 
                    { ready: !currentReady }).then(() => {
                    document.getElementById('readyBtn').textContent = !currentReady ? 'UNREADY' : 'READY';
                    checkAllReady();
                });
            });
        };
        
        function checkAllReady() {
            get(ref(database, `lobbies/${gameState.currentLobby}`)).then((snapshot) => {
                const lobby = snapshot.val();
                const players = lobby.players;
                const allReady = Object.values(players).every(p => p.ready);
                
                if (allReady && Object.keys(players).length >= 1) {
                    const updates = {};
                    updates[`lobbies/${gameState.currentLobby}/gameStarted`] = true;
                    
                    Object.keys(players).forEach(id => {
                        updates[`lobbies/${gameState.currentLobby}/players/${id}/alive`] = true;
                        updates[`lobbies/${gameState.currentLobby}/players/${id}/ready`] = false;
                    });
                    
                    update(ref(database), updates);
                }
            });
        }
        
        window.leaveLobby = function() {
            if (gameState.currentLobby) {
                remove(ref(database, `lobbies/${gameState.currentLobby}/players/${gameState.userId}`));
                if (lobbyListener) lobbyListener();
                gameState.currentLobby = null;
            }
            showScreen('multiplayerScreen');
        };
        
        function startMultiplayerGame(lobby) {
            if (lobbyListener) lobbyListener();
            startGameCommon();
            
            onValue(ref(database, `lobbies/${gameState.currentLobby}/players`), (snapshot) => {
                if (!snapshot.exists()) return;
                
                otherPlayers = {};
                let aliveCount = 0;
                
                snapshot.forEach((child) => {
                    const player = child.val();
                    if (child.key !== gameState.userId) otherPlayers[child.key] = player;
                    if (player.alive) aliveCount++;
                });
                
                if (aliveCount === 1 && gameState.isPlaying) victory();
            });
            
            onValue(ref(database, `lobbies/${gameState.currentLobby}/food`), (snapshot) => {
                if (snapshot.exists()) gameState.food = snapshot.val();
            });
        }
        
        window.showLeaderboard = function() { showScreen('leaderboardScreen'); loadLeaderboard(); };
        window.showSettings = function() { showScreen('settingsScreen'); loadSettings(); };
        window.showShop = function() {
            showScreen('shopScreen');
            document.getElementById('shopCoins').textContent = gameState.coins;
            initializePrizeBelt();
        };
        window.showLocker = function() { showScreen('lockerScreen'); loadLocker(); };
        
        function initializePrizeBelt() {
            const belt = document.getElementById('prizeBelt');
            belt.innerHTML = '';
            belt.classList.remove('spinning');
            belt.style.transition = 'none';
            belt.style.transform = 'translateX(0)';
            
            const skinKeys = Object.keys(SKINS).filter(k => k !== 'default');
            for (let i = 0; i < 50; i++) {
                const randomSkin = skinKeys[Math.floor(Math.random() * skinKeys.length)];
                const skin = SKINS[randomSkin];
                
                const item = document.createElement('div');
                item.className = `prize-item ${skin.rarity}`;
                item.textContent = skin.emoji;
                item.dataset.skinId = randomSkin;
                belt.appendChild(item);
            }
        }
        
        window.spinPrizeBelt = function() {
            if (gameState.coins < 500) { alert('Need 500 coins!'); return; }
            
            const btn = document.getElementById('spinBtn');
            btn.disabled = true;
            
            gameState.coins -= 500;
            update(ref(database, `snakeUsers/${gameState.userId}`), { coins: gameState.coins });
            document.getElementById('shopCoins').textContent = gameState.coins;
            document.getElementById('homeCoins').textContent = gameState.coins;
            
            const rand = Math.random() * 100;
            
            if (rand < 3) wonSkinId = 'legendary';
            else if (rand < 30) {
                const epics = Object.keys(SKINS).filter(k => SKINS[k].rarity === 'epic');
                wonSkinId = epics[Math.floor(Math.random() * epics.length)];
            } else {
                const rares = Object.keys(SKINS).filter(k => SKINS[k].rarity === 'rare');
                wonSkinId = rares[Math.floor(Math.random() * rares.length)];
            }
            
            // Reinitialize belt for new spin
            initializePrizeBelt();
            
            const belt = document.getElementById('prizeBelt');
            const items = belt.querySelectorAll('.prize-item');
            
            // Choose random position between indices 20-30
            const targetIndex = 20 + Math.floor(Math.random() * 11);
            
            items[targetIndex].dataset.skinId = wonSkinId;
            items[targetIndex].textContent = SKINS[wonSkinId].emoji;
            items[targetIndex].className = `prize-item ${SKINS[wonSkinId].rarity}`;
            
            const containerWidth = belt.parentElement.offsetWidth;
            // Random offset within the item to make it less centered
            const randomOffset = (Math.random() - 0.5) * 80; // -40 to +40 pixels
            const scrollAmount = -(targetIndex * 140 - containerWidth / 2 + 60 + randomOffset);
            
            // Force reflow to ensure animation works
            belt.offsetHeight;
            
            belt.classList.add('spinning');
            belt.style.transform = `translateX(${scrollAmount}px)`;
            
            setTimeout(() => {
                get(ref(database, `snakeUsers/${gameState.userId}/skins`)).then((snapshot) => {
                    const skins = snapshot.val() || {};
                    skins[wonSkinId] = (skins[wonSkinId] || 0) + 1;
                    update(ref(database, `snakeUsers/${gameState.userId}`), { skins });
                    
                    showSkinReveal(wonSkinId);
                    btn.disabled = false;
                });
            }, 3000);
        };
        
        function showSkinReveal(skinId) {
            const skin = SKINS[skinId];
            const overlay = document.getElementById('skinRevealOverlay');
            const card = document.getElementById('skinRevealCard');
            
            card.className = `skin-reveal-card ${skin.rarity}`;
            document.getElementById('revealEmoji').textContent = skin.emoji;
            document.getElementById('revealName').textContent = skin.name;
            
            const rarityEl = document.getElementById('revealRarity');
            rarityEl.textContent = skin.rarity;
            rarityEl.className = `skin-reveal-rarity ${skin.rarity}`;
            
            overlay.classList.add('active');
        }
        
        window.equipRevealedSkin = function() {
            gameState.equippedSkin = wonSkinId;
            update(ref(database, `snakeUsers/${gameState.userId}`), { equippedSkin: wonSkinId }).then(() => {
                closeReveal();
            });
        };
        
        window.closeReveal = function() {
            document.getElementById('skinRevealOverlay').classList.remove('active');
        };
        
        function loadLocker() {
            get(ref(database, `snakeUsers/${gameState.userId}`)).then((snapshot) => {
                const userData = snapshot.val();
                const skins = userData.skins || { default: 1 };
                const equipped = userData.equippedSkin || 'default';
                
                const grid = document.getElementById('skinGrid');
                grid.innerHTML = '';
                
                Object.entries(skins).forEach(([skinId, count]) => {
                    const skin = SKINS[skinId];
                    const card = document.createElement('div');
                    card.className = `skin-card ${skin.rarity}` + (skinId === equipped ? ' equipped' : '');
                    card.innerHTML = `
                        <div class="skin-icon">${skin.emoji}</div>
                        <div class="skin-name">${skin.name}</div>
                        <div class="skin-count">x${count}</div>
                        ${skinId === equipped ? '<div style="color: #ffd93d;">‚úì EQUIPPED</div>' : ''}
                    `;
                    card.onclick = () => equipSkin(skinId);
                    grid.appendChild(card);
                });
            });
        }
        
        function equipSkin(skinId) {
            gameState.equippedSkin = skinId;
            update(ref(database, `snakeUsers/${gameState.userId}`), { equippedSkin: skinId }).then(() => loadLocker());
        }
        
        function loadLeaderboard() {
            const list = document.getElementById('leaderboardList');
            const loading = document.getElementById('leaderboardLoading');
            loading.style.display = 'block';
            list.innerHTML = '';
            
            get(ref(database, 'snakeUsers')).then((snapshot) => {
                loading.style.display = 'none';
                if (!snapshot.exists()) {
                    list.innerHTML = '<div style="text-align: center; color: #00ff88; padding: 20px;">No records yet!</div>';
                    return;
                }
                
                const users = [];
                snapshot.forEach((child) => {
                    const userData = child.val();
                    if (userData.highScore > 0) users.push({
                        id: child.key, name: userData.name, highScore: userData.highScore
                    });
                });
                
                users.sort((a, b) => b.highScore - a.highScore).slice(0, 50).forEach((user, index) => {
                    const entry = document.createElement('div');
                    entry.className = 'leaderboard-entry' + (user.id === gameState.userId ? ' current-user' : '');
                    entry.innerHTML = `
                        <span><span class="rank">#${index + 1}</span>${user.name}</span>
                        <span>${user.highScore} pts</span>
                    `;
                    list.appendChild(entry);
                });
            });
        }
        
        function loadSettings() {
            get(ref(database, `snakeUsers/${gameState.userId}`)).then((snapshot) => {
                const d = snapshot.val();
                document.getElementById('settingsName').textContent = d.name;
                document.getElementById('settingsHighScore').textContent = d.highScore || 0;
                document.getElementById('settingsBestTime').textContent = (d.bestTime || 0) + 's';
                document.getElementById('settingsGamesPlayed').textContent = d.gamesPlayed || 0;
                document.getElementById('settingsCoins').textContent = d.coins || 0;
                document.getElementById('settingsAvgScore').textContent = 
                    d.gamesPlayed > 0 ? Math.round(d.totalScore / d.gamesPlayed) : 0;
                
                const daysSince = (Date.now() - (d.lastNameChange || 0)) / (1000 * 60 * 60 * 24);
                const daysRem = Math.max(0, Math.ceil(10 - daysSince));
                document.getElementById('nameChangeInfo').textContent = 
                    daysRem > 0 ? `Name change in ${daysRem} days` : 'Name change available!';
            });
        }
        
        function gameOver() {
            // Check for extra life (legendary skin)
            if (gameState.hasExtraLife && !gameState.usedExtraLife) {
                gameState.usedExtraLife = true;
                gameState.isReviving = true;
                gameState.reviveFlickerCount = 0;
                savedSnakeLength = gameState.snake.length; // Save current length
                
                // Respawn at center with same length
                const centerX = Math.floor(tileCount / 2);
                const centerY = Math.floor(tileCount / 2);
                gameState.snake = [];
                
                for (let i = 0; i < savedSnakeLength; i++) {
                    gameState.snake.push({x: centerX - i, y: centerY});
                }
                
                gameState.direction = {x: 1, y: 0};
                gameState.nextDirection = {x: 1, y: 0};
                document.getElementById('extraLifeIndicator').style.display = 'none';
                
                return; // Don't end game, continue playing with flickering effect
            }
            
            gameState.isPlaying = false;
            clearInterval(gameInterval);
            
            const survivalTime = Math.floor((Date.now() - gameState.startTime) / 1000);
            const coinsEarned = gameState.foodEaten;
            gameState.coins += coinsEarned;
            
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalTime').textContent = survivalTime;
            document.getElementById('finalLength').textContent = gameState.snake.length;
            document.getElementById('coinsEarned').textContent = coinsEarned;
            
            get(ref(database, `snakeUsers/${gameState.userId}`)).then((snapshot) => {
                const d = snapshot.val();
                const updates = {
                    gamesPlayed: (d.gamesPlayed || 0) + 1,
                    totalScore: (d.totalScore || 0) + gameState.score,
                    coins: gameState.coins
                };
                if (gameState.score > (d.highScore || 0)) updates.highScore = gameState.score;
                if (survivalTime > (d.bestTime || 0)) updates.bestTime = survivalTime;
                update(ref(database, `snakeUsers/${gameState.userId}`), updates);
            });
            
            if (gameState.isMultiplayer) {
                update(ref(database, `lobbies/${gameState.currentLobby}/players/${gameState.userId}`), { alive: false });
                showScreen('homeScreen');
            } else {
                showScreen('gameOverScreen');
            }
        }
        
        function victory() {
            gameState.isPlaying = false;
            clearInterval(gameInterval);
            
            document.getElementById('victoryScore').textContent = gameState.score;
            document.getElementById('victoryLength').textContent = gameState.snake.length;
            
            const coinsEarned = gameState.foodEaten;
            gameState.coins += coinsEarned;
            update(ref(database, `snakeUsers/${gameState.userId}`), { coins: gameState.coins });
            
            showScreen('victoryScreen');
        }
        
        function initGame() {
            gameState.snake = [{x: Math.floor(tileCount/2), y: Math.floor(tileCount/2)}];
            gameState.direction = {x: 1, y: 0};
            gameState.nextDirection = {x: 1, y: 0};
            spawnFood();
            updateHUD();
        }
        
        function spawnFood() {
            let valid = false;
            while (!valid) {
                gameState.food = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount)
                };
                valid = !gameState.snake.some(s => s.x === gameState.food.x && s.y === gameState.food.y);
            }
            if (gameState.isMultiplayer) {
                set(ref(database, `lobbies/${gameState.currentLobby}/food`), gameState.food);
            }
        }
        
        function gameLoop() {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            rainbowHue = (rainbowHue + 2) % 360;
            
            // Handle revival flickering
            if (gameState.isReviving) {
                gameState.reviveFlickerCount++;
                if (gameState.reviveFlickerCount > 20) { // Stop flickering after 2 seconds
                    gameState.isReviving = false;
                }
            }
            
            gameState.direction = gameState.nextDirection;
            const head = {
                x: gameState.snake[0].x + gameState.direction.x,
                y: gameState.snake[0].y + gameState.direction.y
            };
            
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                gameOver();
                return;
            }
            
            if (gameState.snake.some(s => s.x === head.x && s.y === head.y)) {
                gameOver();
                return;
            }
            
            gameState.snake.unshift(head);
            
            if (head.x === gameState.food.x && head.y === gameState.food.y) {
                gameState.score += 10;
                gameState.foodEaten++;
                gameState.coins++;
                document.getElementById('coins').textContent = gameState.coins;
                spawnFood();
            } else {
                gameState.snake.pop();
            }
            
            if (gameState.isMultiplayer) {
                update(ref(database, `lobbies/${gameState.currentLobby}/players/${gameState.userId}`), {
                    snake: gameState.snake, score: gameState.score
                });
            }
            
            updateHUD();
            draw();
        }
        
        function drawSnakeSegment(x, y, index, totalLength, skin) {
            // Flickering effect during revival
            if (gameState.isReviving && Math.floor(gameState.reviveFlickerCount / 2) % 2 === 0) {
                return; // Skip drawing to create flicker
            }
            
            const skinData = SKINS[skin] || SKINS.default;
            
            if (skinData.pattern === 'rainbow') {
                const hue = (rainbowHue + index * 10) % 360;
                ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            } else if (skinData.pattern === 'gradient' && skinData.gradient) {
                const gradient = ctx.createLinearGradient(
                    x * gridSize, y * gridSize,
                    (x + 1) * gridSize, (y + 1) * gridSize
                );
                gradient.addColorStop(0, skinData.gradient[0]);
                gradient.addColorStop(1, skinData.gradient[1]);
                ctx.fillStyle = gradient;
            } else {
                const alpha = 1 - (index / totalLength) * 0.5;
                ctx.fillStyle = skinData.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
            }
            
            if (skinData.glow) {
                ctx.shadowBlur = 10;
                ctx.shadowColor = skinData.color;
            }
            
            ctx.fillRect(x * gridSize + 1, y * gridSize + 1, gridSize - 2, gridSize - 2);
            
            if (skinData.pattern === 'scales' && index > 0) {
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x * gridSize + gridSize/2, y * gridSize + gridSize/2, gridSize/3, 0, Math.PI * 2);
                ctx.stroke();
            } else if (skinData.pattern === 'stars' && index % 2 === 0) {
                ctx.fillStyle = '#fff';
                ctx.fillRect(x * gridSize + gridSize/2 - 1, y * gridSize + gridSize/2 - 1, 2, 2);
            }
            
            ctx.shadowBlur = 0;
        }
        
        function draw() {
            ctx.fillStyle = '#0f3460';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = 'rgba(0, 255, 136, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= tileCount; i++) {
                ctx.beginPath();
                ctx.moveTo(i * gridSize, 0);
                ctx.lineTo(i * gridSize, canvas.height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, i * gridSize);
                ctx.lineTo(canvas.width, i * gridSize);
                ctx.stroke();
            }
            
            if (gameState.isMultiplayer) {
                Object.entries(otherPlayers).forEach(([id, player]) => {
                    if (!player.snake || !player.alive) return;
                    
                    player.snake.forEach((s, i) => {
                        drawSnakeSegment(s.x, s.y, i, player.snake.length, player.skin);
                    });
                    
                    if (player.snake[0]) {
                        ctx.fillStyle = player.color;
                        ctx.font = '10px Courier';
                        ctx.fillText(player.name, player.snake[0].x * gridSize, player.snake[0].y * gridSize - 5);
                    }
                });
            }
            
            gameState.snake.forEach((s, i) => {
                drawSnakeSegment(s.x, s.y, i, gameState.snake.length, gameState.equippedSkin);
                
                if (i === 0 && (!gameState.isReviving || Math.floor(gameState.reviveFlickerCount / 2) % 2 === 1)) {
                    ctx.globalAlpha = 1;
                    ctx.fillStyle = '#000';
                    const e = 3, o = 5;
                    if (gameState.direction.x !== 0) {
                        ctx.fillRect(s.x * gridSize + o, s.y * gridSize + 4, e, e);
                        ctx.fillRect(s.x * gridSize + o, s.y * gridSize + 12, e, e);
                    } else {
                        ctx.fillRect(s.x * gridSize + 4, s.y * gridSize + o, e, e);
                        ctx.fillRect(s.x * gridSize + 12, s.y * gridSize + o, e, e);
                    }
                }
            });
            ctx.globalAlpha = 1;
            
            if (gameState.isMultiplayer && gameState.snake[0]) {
                ctx.fillStyle = gameState.playerColor;
                ctx.font = '10px Courier';
                ctx.fillText(gameState.userName, gameState.snake[0].x * gridSize, gameState.snake[0].y * gridSize - 5);
            }
            
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#ff4757';
            ctx.fillStyle = '#ff4757';
            ctx.beginPath();
            ctx.arc(
                gameState.food.x * gridSize + gridSize / 2,
                gameState.food.y * gridSize + gridSize / 2,
                gridSize / 2 - 2, 0, Math.PI * 2
            );
            ctx.fill();
            ctx.shadowBlur = 0;
        }
        
        function updateHUD() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('length').textContent = gameState.snake.length;
            document.getElementById('timer').textContent = 
                Math.floor((Date.now() - gameState.startTime) / 1000) + 's';
        }
        
        document.addEventListener('keydown', (e) => {
            if (!gameState.isPlaying || gameState.isPaused) return;
            const k = e.key.toLowerCase();
            if ((k === 'w' || k === 'arrowup') && gameState.direction.y === 0) {
                gameState.nextDirection = {x: 0, y: -1};
                e.preventDefault();
            } else if ((k === 's' || k === 'arrowdown') && gameState.direction.y === 0) {
                gameState.nextDirection = {x: 0, y: 1};
                e.preventDefault();
            } else if ((k === 'a' || k === 'arrowleft') && gameState.direction.x === 0) {
                gameState.nextDirection = {x: -1, y: 0};
                e.preventDefault();
            } else if ((k === 'd' || k === 'arrowright') && gameState.direction.x === 0) {
                gameState.nextDirection = {x: 1, y: 0};
                e.preventDefault();
            }
        });
        
        checkExistingUser();
    </script>
</body>
</html>
